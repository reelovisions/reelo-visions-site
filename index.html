<#  Sync-Git.ps1
    Usage:
      .\Sync-Git.ps1 -RepoPath "C:\Users\sjrya\OneDrive\Desktop\reelo-visions-site" -CommitMsg "Update homepage"
    Optional:
      -PullFirst:$false   # skip pulling if you know you're ahead
      -ForcePush:$true    # if remote rejected (only use if you know what you're doing)
#>

param(
  [Parameter(Mandatory=$true)] [string]$RepoPath,
  [string]$CommitMsg = "Sync from local $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')",
  [bool]$PullFirst = $true,
  [bool]$ForcePush = $false
)

function Run($cmd, $errMsg){
  & $cmd
  if ($LASTEXITCODE -ne 0) { throw "$errMsg`nCommand: $cmd" }
}

# 0) Sanity checks
if (-not (Get-Command git -ErrorAction SilentlyContinue)) {
  throw "Git is not installed or not on PATH."
}
if (-not (Test-Path $RepoPath)) {
  throw "RepoPath not found: $RepoPath"
}

Push-Location $RepoPath
try {
  # 1) Confirm we're inside a git repo
  Run 'git rev-parse --is-inside-work-tree' "Not a git repository: $RepoPath" | Out-Null

  # 2) Determine branch and remote
  $branch = (git rev-parse --abbrev-ref HEAD).Trim()
  if ([string]::IsNullOrWhiteSpace($branch)) { throw "Could not determine current branch." }
  $remote = (git remote).Split("`n") | Where-Object { $_.Trim() -ne "" } | Select-Object -First 1
  if (-not $remote) { throw "No git remote found. Add one: git remote add origin <https://github.com/user/repo.git>" }

  Write-Host "→ Repo:    $RepoPath" -ForegroundColor Cyan
  Write-Host "→ Branch:  $branch" -ForegroundColor Cyan
  Write-Host "→ Remote:  $remote" -ForegroundColor Cyan

  # 3) Fetch & (optionally) pull with rebase
  Run 'git fetch --all --prune' "git fetch failed"
  if ($PullFirst) {
    # Stash local changes (if any) to avoid pull conflicts
    $status = (git status --porcelain)
    $stashed = $false
    if ($status) {
      Write-Host "Stashing local changes…" -ForegroundColor Yellow
      Run 'git stash push -u -m "autosave: Sync-Git.ps1"' "git stash failed"
      $stashed = $true
    }

    Write-Host "Pulling (rebase) from $remote/$branch…" -ForegroundColor Yellow
    Run "git pull --rebase $remote $branch" "git pull --rebase failed"

    if ($stashed) {
      Write-Host "Re-applying stash…" -ForegroundColor Yellow
      # Try to apply; if conflicts arise, user will resolve
      Run 'git stash pop' "git stash pop failed; resolve conflicts then commit/push manually"
    }
  }

  # 4) Stage everything (adds/changes/deletes)
  Run 'git add -A' "git add failed"

  # 5) Commit if there are staged changes
  $changes = (git diff --cached --name-status)
  if ($changes) {
    Write-Host "Committing changes…" -ForegroundColor Yellow
    Run "git commit -m `"$CommitMsg`"" "git commit failed"
  } else {
    Write-Host "No changes to commit." -ForegroundColor Green
  }

  # 6) Push
  Write-Host "Pushing to $remote/$branch…" -ForegroundColor Yellow
  $pushCmd = "git push $remote $branch"
  $push = cmd /c $pushCmd
  if ($LASTEXITCODE -ne 0 -and $ForcePush) {
    Write-Host "Normal push failed. Force pushing…" -ForegroundColor Red
    Run "git push --force-with-lease $remote $branch" "git force push failed"
  } elseif ($LASTEXITCODE -ne 0) {
    throw "git push failed. Try: git pull --rebase, resolve conflicts, then rerun with -ForcePush:`$true only if necessary."
  }

  # 7) Done
  Write-Host "`n✔ Sync complete." -ForegroundColor Green
  git status -sb
}
finally {
  Pop-Location
}
