<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Reelo Receptionist — Admin (Frontend UX v1)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root { --bg:#0b1020; --card:#121a33; --muted:#9fb0e0; --text:#eaf0ff; --accent:#7aa2ff; --line:#1f2b52; }
      html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
      .wrap{max-width:1100px;margin:28px auto;padding:16px}
      .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 3px 20px rgba(0,0,0,.2);margin-bottom:14px}
      h1{margin:0 0 16px;font-size:22px}
      h3{margin:10px 0 8px}
      label{display:inline-flex;align-items:center;gap:8px;margin:6px 12px 6px 0}
      input,select{background:#0e152b;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
      button{background:var(--accent);color:#05122a;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
      button:hover{filter:brightness(1.08)}
      .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
      .stack{display:flex;flex-direction:column;gap:10px}
      .muted{color:var(--muted);font-size:12px}
      pre{background:#0e152b;color:#cfe0ff;padding:10px;border-radius:10px;overflow:auto;max-height:260px;border:1px solid var(--line)}
      hr{border:0;height:1px;background:var(--line);margin:12px 0}
      .hidden{display:none}
      .right{margin-left:auto}
      .grid{display:grid;grid-template-columns: 1fr 1fr; gap: 12px;}
      @media (max-width: 980px){ .grid { grid-template-columns: 1fr; } }
      .cardlist{display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px;}
      .appt{border:1px solid var(--line); border-radius:10px; padding:10px; background:#0e152b;}
      .appt h4{margin:0 0 8px; font-size:16px}
      .pill{display:inline-block; background:#1b2750; padding:2px 8px; border-radius:999px; font-size:12px; color:#9fb0e0; margin-left:6px;}
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Reelo Receptionist — Admin (v1 UX)</h1>

      <!-- Auth (shown when signed OUT) -->
      <div class="card" id="authCard">
        <h3>Sign in</h3>
        <div class="row">
          <label>Email <input id="email" value="steve@test.com"></label>
          <label>Password <input id="password" type="password" value="changeme"></label>
          <button id="loginBtn">Log in</button>
        </div>
        <div class="muted">Use a user that exists in Supabase → Auth → Users.</div>
        <pre id="authOut"></pre>
      </div>

      <!-- App (hidden until login) -->
      <div id="app" class="hidden">
        <div class="row" style="gap:6px">
          <div class="muted" id="userInfo"></div>
          <button id="logoutBtn" class="right">Log out</button>
        </div>

        <div class="card">
          <h3>Create Appointment</h3>
          <div class="stack">
            <div class="row">
              <label>First <input id="first" placeholder="Jane"></label>
              <label>Last <input id="last" placeholder="Customer"></label>
              <label>Phone <input id="phone" placeholder="555-111-2222"></label>
            </div>
            <div class="row">
              <label>Street <input id="street" style="width:320px" placeholder="123 Main St"></label>
              <label>City <input id="city" style="width:160px" placeholder="Anytown"></label>
              <label>State <input id="state" style="width:80px" placeholder="MN" maxlength="2"></label>
              <label>ZIP <input id="zip" style="width:100px" value="55303"></label>
            </div>
            <div class="row">
              <label>Type
                <select id="apptType">
                  <option value="service">Service</option>
                  <option value="quote">Quote</option>
                  <option value="install">Install</option>
                </select>
              </label>
            </div>
            <div class="row">
              <span>Start</span>
              <label>Hour
                <select id="startHour"></select>
              </label>
              <label>Min
                <select id="startMin">
                  <option>00</option>
                  <option>15</option>
                  <option>30</option>
                  <option>45</option>
                </select>
              </label>
              <label>AM/PM
                <select id="startAmPm">
                  <option>AM</option>
                  <option>PM</option>
                </select>
              </label>

              <span style="margin-left:16px">End</span>
              <label>Hour
                <select id="endHour"></select>
              </label>
              <label>Min
                <select id="endMin">
                  <option>00</option>
                  <option>15</option>
                  <option>30</option>
                  <option>45</option>
                </select>
              </label>
              <label>AM/PM
                <select id="endAmPm">
                  <option>AM</option>
                  <option>PM</option>
                </select>
              </label>
              <label>Date <input id="date" type="date"></label>
              <button id="createBtn">Create Appointment</button>
            </div>
            <div class="muted">Times save in UTC in the DB; we render them in your local timezone below.</div>
            <pre id="createOut"></pre>
          </div>
        </div>

        <div class="card">
          <h3>My Appointments</h3>
          <div class="row">
            <button id="listBtn">List (active)</button>
            <button id="listAllBtn">List (include canceled)</button>
            <button id="csvBtn">Download CSV</button>
          </div>
          <div id="cards" class="cardlist"></div>
          <pre id="listOut" class="hidden"></pre>
        </div>

        <div class="card">
          <h3>Service Area Admin</h3>
          <div class="row">
            <label>Add ZIP <input id="adminZip" value="55401"></label>
            <button id="addZipBtn">Add ZIP</button>
          </div>
          <div class="row">
            <label>Miles <input id="miles" type="number" value="25" style="width:80px"></label>
            <label>HQ Lat <input id="lat" value="45.226" style="width:120px"></label>
            <label>HQ Lon <input id="lon" value="-93.389" style="width:120px"></label>
            <button id="setRadiusBtn">Set Radius</button>
          </div>
          <pre id="adminOut"></pre>
        </div>

        <div class="card">
          <h3>Manage An Appointment</h3>
          <div class="row">
            <label>Appt ID <input id="apptId" placeholder="paste a UUID" style="width:340px"></label>
            <button id="cancelBtn">Cancel</button>
            <button id="updateBtn">Update Name → “Updated”</button>
          </div>
          <pre id="manageOut"></pre>
        </div>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      // Your project values (from earlier messages)
      const SUPABASE_URL = "https://yvjwajopxbcaedzofqww.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2andham9weGJjYWVkem9mcXd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODk0NjQsImV4cCI6MjA3NDk2NTQ2NH0.1VVEkgThCltfebpCWa-4DReb9qSO5zdt2a_83CfsBsY";

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const $ = (id) => document.getElementById(id);
      const set = (id, v) => { $(id).textContent = v; };

      function showApp(user){ $("authCard").classList.add("hidden"); $("app").classList.remove("hidden"); $("userInfo").textContent = `Signed in as ${user.email}`; }
      function showLogin(){ $("app").classList.add("hidden"); $("authCard").classList.remove("hidden"); set("authOut",""); $("userInfo").textContent=""; }

      // populate hour dropdowns (1..12)
      function fillHours(selId){ const s=$(selId); s.innerHTML=""; for(let h=1; h<=12; h++){ const o=document.createElement('option'); o.value=String(h).padStart(2,'0'); o.textContent=o.value; s.appendChild(o); } }
      ["startHour","endHour"].forEach(fillHours);

      // default date = today; default time = next quarter hour
      (function initDefaults(){
        const now=new Date();
        $("date").value = now.toISOString().slice(0,10);
        const mins = now.getMinutes();
        const nextQ = mins%15===0 ? mins : mins + (15 - (mins%15));
        const hour12 = (h)=>{ h = h%12; return h===0?12:h; };
        const ampm = now.getHours()>=12 ? "PM" : "AM";
        $("startHour").value = String(hour12(now.getHours())).padStart(2,'0');
        $("startMin").value = String((nextQ)%60).padStart(2,'0');
        $("startAmPm").value = ampm;
        // end = +1 hour, same minutes
        const end = new Date(now.getTime()+60*60*1000);
        $("endHour").value = String(hour12(end.getHours())).padStart(2,'0');
        $("endMin").value = $("startMin").value;
        $("endAmPm").value = end.getHours()>=12 ? "PM" : "AM";
      })();

      // Convert hour/min/AMPM + date into ISO string (local → UTC)
      function toIso(dateStr, hourSel, minSel, ampmSel){
        if(!dateStr) return new Date().toISOString();
        let h = parseInt($(hourSel).value,10);
        const m = parseInt($(minSel).value,10);
        const isPm = $(ampmSel).value === "PM";
        h = (h % 12) + (isPm ? 12 : 0);
        const dt = new Date(dateStr + "T00:00:00");
        dt.setHours(h, m, 0, 0);
        return dt.toISOString();
      }

      // session restore
      (async ()=>{
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) showApp(session.user);
      })();
      supabase.auth.onAuthStateChange((_evt, session)=>{ if(session?.user) showApp(session.user); else showLogin(); });

      // Auth
      $("loginBtn").onclick = async ()=>{
        const { data, error } = await supabase.auth.signInWithPassword({ email: $("email").value.trim(), password: $("password").value });
        set("authOut", error ? `Login error: ${error.message}` : `Logged in user: ${data.user.id}`);
      };
      $("logoutBtn").onclick = async ()=>{ await supabase.auth.signOut(); showLogin(); };

      // Create
      $("createBtn").onclick = async ()=>{
        const first = $("first").value.trim();
        const last  = $("last").value.trim();
        const phone = $("phone").value.trim();
        const street= $("street").value.trim();
        const city  = $("city").value.trim();
        const state = $("state").value.trim();
        const zip   = $("zip").value.trim();
        const type  = $("apptType").value;
        const date  = $("date").value;

        const startISO = toIso(date, "startHour", "startMin", "startAmPm");
        const endISO   = toIso(date, "endHour", "endMin", "endAmPm");

        const name = [first,last].filter(Boolean).join(" ").trim() || "Unnamed";
        const address = [street, city && (city+","), state, zip].filter(Boolean).join(" ").replace(" ,", ",");
        const notes = { source:"web", first_name:first, last_name:last, street, city, state, appt_type:type, end_time:endISO };

        const { data, error } = await supabase.rpc("create_my_appointment", {
          p_customer_name: name,
          p_customer_phone: phone,
          p_address: address,
          p_zip: zip,
          p_notes: notes,
          p_appt_time: startISO
        });
        set("createOut", error ? `RPC error: ${error.message}` : `New appt id: ${data}`);
        if(!error) await list(false);
      };

      // Render helpers
      const fmt = (ts)=> new Date(ts).toLocaleString();
      function renderCards(rows){
        const c = $("cards"); c.innerHTML = "";
        rows.forEach(r=>{
          const noteType = (r.notes && r.notes.appt_type) ? String(r.notes.appt_type) : null;
          const endLocal = (r.notes && r.notes.end_time) ? fmt(r.notes.end_time) : null;
          const div = document.createElement("div");
          div.className = "appt";
          div.innerHTML = `
            <h4>${r.customer_name}${noteType ? `<span class="pill">${noteType}</span>`:""}</h4>
            <div><strong>When:</strong> ${fmt(r.appt_time)}${endLocal ? ` → ${endLocal}`:""}</div>
            <div><strong>Where:</strong> ${r.address}</div>
            <div><strong>ZIP:</strong> ${r.zip}</div>
            <div><strong>Phone:</strong> ${r.customer_phone || ""}</div>
            <div style="margin-top:6px"><strong>ID:</strong> <code>${r.id}</code></div>
          `;
          c.appendChild(div);
        });
      }

      async function list(includeCanceled){
        const { data, error } = await supabase.rpc("list_my_appointments", { p_limit: 50, p_offset: 0, p_include_canceled: !!includeCanceled });
        if(error){ set("listOut", `List error: ${error.message}`); $("listOut").classList.remove("hidden"); return; }
        $("listOut").classList.add("hidden");
        renderCards(data||[]);
      }

      $("listBtn").onclick = ()=>list(false);
      $("listAllBtn").onclick = ()=>list(true);

      // CSV (all)
      $("csvBtn").onclick = async ()=>{
        const { data, error } = await supabase.rpc("list_my_appointments", { p_limit: 1000, p_offset: 0, p_include_canceled: true });
        if (error) return alert(error.message);
        const rows = data || [];
        const headers = ["id","appt_time","customer_name","customer_phone","address","zip","notes","canceled_at"];
        const csv = [headers.join(",")]
          .concat(rows.map(r => headers.map(h => {
            let v = r[h]; if (v == null) return "";
            if (typeof v === "object") v = JSON.stringify(v);
            v = String(v).replace(/"/g,'""'); return `"${v}"`;
          }).join(","))).join("\r\n");
        const url = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" }));
        const a = document.createElement("a"); a.href = url; a.download = "appointments.csv"; a.click();
        URL.revokeObjectURL(url);
      };

      // Admin
      $("addZipBtn").onclick = async ()=>{
        const zip = $("adminZip").value.trim();
        const { error } = await supabase.rpc("add_my_zip", { p_zip: zip });
        set("adminOut", error ? `add_my_zip error: ${error.message}` : `Added ZIP ${zip}`);
      };
      $("setRadiusBtn").onclick = async ()=>{
        const miles = parseInt($("miles").value, 10);
        const lat = parseFloat($("lat").value);
        const lon = parseFloat($("lon").value);
        const { error } = await supabase.rpc("set_my_radius", { p_use_radius: true, p_radius_miles: miles, p_hq_lat: lat, p_hq_lon: lon });
        set("adminOut", error ? `set_my_radius error: ${error.message}` : `Radius set to ${miles} mi @ (${lat}, ${lon})`);
      };

      // Manage
      $("cancelBtn").onclick = async ()=>{
        const id = $("apptId").value.trim();
        if(!id) return set("manageOut","Enter an appointment id");
        const { error } = await supabase.rpc("cancel_my_appointment", { p_id: id });
        set("manageOut", error ? `Cancel error: ${error.message}` : `Canceled ${id}`);
        if(!error) await list(false);
      };
      $("updateBtn").onclick = async ()=>{
        const id = $("apptId").value.trim();
        if(!id) return set("manageOut","Enter an appointment id");
        const { error } = await supabase.rpc("update_my_appointment", { p_id: id, p_customer_name: "Updated" });
        set("manageOut", error ? `Update error: ${error.message}` : `Updated ${id}`);
        if(!error) await list(false);
      };
    </script>
  </body>
</html>
