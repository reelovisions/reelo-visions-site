<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Â· Demo Calls</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2b;--muted:#23304a;--text:#e6ecff;--sub:#97a3c0;--ok:#16a34a;--err:#ef4444;--brand:#2563eb}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Inter,Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 16px;font-size:22px}
    .card{background:var(--card);border:1px solid var(--muted);border-radius:12px;padding:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input,button{border-radius:10px;border:1px solid var(--muted);background:#0e1627;color:var(--text);padding:10px 12px}
    button{background:var(--brand);border:0;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
    th,td{border-bottom:1px solid var(--muted);padding:10px 8px;text-align:left;vertical-align:top}
    th{color:var(--sub);font-weight:600}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .ok{background:rgba(22,163,74,.12);color:var(--ok);border:1px solid rgba(22,163,74,.25)}
    .fail{background:rgba(239,68,68,.12);color:var(--err);border:1px solid rgba(239,68,68,.25)}
    .muted{color:var(--sub)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Demo Calls</h1>
    <div class="card">
      <div class="row">
        <input id="token" placeholder="Admin token" style="min-width:260px">
        <input id="q" placeholder="Search company/email/phone" style="flex:1;min-width:220px">
        <button id="load">Refresh</button>
        <button id="csv">Export CSV</button>
      </div>
      <div class="muted" id="info"></div>
      <table id="t">
        <thead>
          <tr>
            <th>Time (UTC)</th><th>Company</th><th>Email</th><th>Phone</th><th>Country</th><th>Status</th><th>SID</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
<script>
const els={token:$('#token'), q:$('#q'), info:$('#info'), tbody:$('#t tbody')};
function $(s,d=document){return d.querySelector(s)}
function fmtTs(s){try{return new Date(s).toISOString().replace('T',' ').replace('Z','')}catch{return s}}
function toCSV(rows){const head=['ts','company','email','phone_e164','country','status','tw_sid'];const esc=v=>('"'+String(v??'').replace(/"/g,'""')+'"');return [head.join(','),...rows.map(r=>head.map(k=>esc(r[k])).join(','))].join('\n')}
function render(rows){
  const q=(els.q.value||'').toLowerCase();
  const view = q ? rows.filter(r => [r.company,r.email,r.phone_e164].some(x => String(x||'').toLowerCase().includes(q))) : rows;
  els.tbody.innerHTML = view.map(r=>`
    <tr>
      <td>${fmtTs(r.ts)}</td>
      <td>${r.company??''}</td>
      <td>${r.email??''}</td>
      <td>${r.phone_e164??''}</td>
      <td>${r.country??''}</td>
      <td><span class="pill ${r.status==='ok'?'ok':'fail'}">${r.status??''}</span></td>
      <td class="muted">${r.tw_sid??''}</td>
    </tr>`).join('');
  els.info.textContent = `${view.length} shown (${rows.length} total)`;
}
async function load(){
  const token=els.token.value.trim()||localStorage.getItem('admin_token')||'';
  if(!token){alert('Enter the admin token'); return;}
  localStorage.setItem('admin_token', token);
  const r = await fetch('/api/admin-calls', { headers: { Authorization: 'Bearer '+token }});
  const data = await r.json().catch(()=>({}));
  if(!r.ok || !data.ok){alert('Auth failed or server error'); return;}
  window.__rows = data.rows || [];
  render(window.__rows);
}
$('#load').onclick = load;
$('#csv').onclick = ()=>{ if(!window.__rows) return; const blob=new Blob([toCSV(window.__rows)],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='demo-calls.csv'; a.click(); };
els.q.oninput = ()=> render(window.__rows||[]);
window.addEventListener('DOMContentLoaded',()=>{ const t=localStorage.getItem('admin_token'); if(t){els.token.value=t; load();}});
</script>
</body>
</html>
