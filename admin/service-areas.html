<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Service Areas | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.ico" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; margin: 24px; }
    header { display:flex; gap:16px; align-items:center; margin-bottom:16px; }
    nav a { margin-right: 12px; text-decoration:none; color:#0366d6; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; max-width:820px; }
    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { padding:10px; border-bottom:1px solid #f0f0f0; text-align:left; }
    input[type=text] { padding:8px; border:1px solid #d1d5db; border-radius:8px; width:140px; }
    button { padding:8px 12px; border:1px solid #d1d5db; background:#fff; border-radius:8px; cursor:pointer; }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    .row { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .status { margin-top:10px; font-size:14px; }
    .status.ok { color:#065f46; }
    .status.err { color:#991b1b; }
    .muted { color:#6b7280; font-size:13px; }
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; vertical-align: middle; }
    .switch input { display:none; }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#d1d5db; transition:.2s; border-radius:999px; }
    .slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; top:3px; background:white; transition:.2s; border-radius:50%; box-shadow:0 1px 2px rgba(0,0,0,.12); }
    input:checked + .slider { background:#111827; }
    input:checked + .slider:before { transform: translateX(20px); }
    .inline { display:flex; align-items:center; gap:10px; }
    .section-title { margin-top:0; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <header>
    <h1 style="margin:0;">Service Areas</h1>
  </header>

  <nav>
    <a href="/admin/index.html">Dashboard</a>
    <a href="/admin/service-areas.html"><strong>Service Areas</strong></a>
    <a href="#" id="logout-link">Logout</a>
  </nav>

  <div class="card">
    <h3 class="section-title">Policy</h3>
    <div class="inline">
      <label class="switch">
        <input type="checkbox" id="enforceSwitch" />
        <span class="slider"></span>
      </label>
      <div>
        <div><strong>Enforce service ZIPs</strong></div>
        <div class="muted">If ON, new appointments must match your ZIP list. If OFF, any ZIP is accepted (useful for demo/testing).</div>
      </div>
    </div>
    <div id="policyStatus" class="status"></div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #eee;" />

    <h3 class="section-title">ZIP Codes</h3>
    <div class="row">
      <label for="zipInput">Add ZIP</label>
      <input id="zipInput" type="text" pattern="\\d{5}" maxlength="5" placeholder="e.g. 55401" />
      <button class="primary" id="addBtn">Add</button>
    </div>
    <div class="muted">Must be exactly 5 digits. Duplicate adds are ignored (upsert).</div>

    <table id="zipsTable">
      <thead>
        <tr><th>ZIP</th><th style="width:120px;">Action</th></tr>
      </thead>
      <tbody id="zipsBody"></tbody>
    </table>

    <div id="status" class="status"></div>
  </div>

<script>
  // ---------- Config ----------
  const SUPABASE_URL = 'https://yvjwajopxbcaedzofqww.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2andham9weGJjYWVkem9mcXd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODk0NjQsImV4cCI6MjA3NDk2NTQ2NH0.1VVEkgThCltfebpCWa-4DReb9qSO5zdt2a_83CfsBsY'; // same as other admin pages
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---------- Auth Guard ----------
  (async () => {
    const { data: { session } } = await client.auth.getSession();
    if (!session) {
      window.location.href = '/admin/login.html';
      return;
    }
    await loadPolicy();
    await loadZips();
  })();

  document.getElementById('logout-link').addEventListener('click', async (e) => {
    e.preventDefault();
    await client.auth.signOut();
    window.location.href = '/admin/login.html';
  });

  const statusEl = document.getElementById('status');
  const policyStatusEl = document.getElementById('policyStatus');
  function toastOk(msg) { statusEl.textContent = msg; statusEl.className = 'status ok'; }
  function toastErr(msg) { statusEl.textContent = msg; statusEl.className = 'status err'; }
  function policyOk(msg) { policyStatusEl.textContent = msg; policyStatusEl.className = 'status ok'; }
  function policyErr(msg) { policyStatusEl.textContent = msg; policyStatusEl.className = 'status err'; }

  // ---------- Policy toggle ----------
  const enforceSwitch = document.getElementById('enforceSwitch');

  async function loadPolicy() {
    policyStatusEl.textContent = 'Loading policy…';
    const { data, error } = await client.rpc('get_company_settings');
    if (error) { policyErr(error.message); return; }
    enforceSwitch.checked = !!(data && data.enforce_zip);
    policyOk(`Enforce service ZIPs is ${enforceSwitch.checked ? 'ON' : 'OFF'}`);
  }

  enforceSwitch.addEventListener('change', async () => {
    const newVal = enforceSwitch.checked;
    const { data, error } = await client.rpc('set_enforce_zip', { p_enforce: newVal });
    if (error) { enforceSwitch.checked = !newVal; policyErr(error.message); return; }
    policyOk(`Enforce service ZIPs is ${newVal ? 'ON' : 'OFF'}`);
  });

  // ---------- ZIP CRUD ----------
  async function loadZips() {
    statusEl.textContent = '';
    const tbody = document.getElementById('zipsBody');
    tbody.innerHTML = '<tr><td colspan="2" class="muted">Loading…</td></tr>';

    const { data, error } = await client
      .from('company_zipcodes')
      .select('zipcode')
      .order('zipcode');

    if (error) {
      tbody.innerHTML = '';
      toastErr(error.message);
      return;
    }

    tbody.innerHTML = '';
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="2" class="muted">No ZIPs yet.</td></tr>';
      return;
    }

    for (const row of data) {
      tbody.appendChild(renderRow(row.zipcode));
    }
  }

  function renderRow(zip) {
    const tr = document.createElement('tr');
    const tdZip = document.createElement('td');
    tdZip.textContent = zip;

    const tdAct = document.createElement('td');
    const delBtn = document.createElement('button');
    delBtn.textContent = 'Delete';
    delBtn.addEventListener('click', () => onDelete(zip));
    tdAct.appendChild(delBtn);

    tr.appendChild(tdZip);
    tr.appendChild(tdAct);
    return tr;
  }

  async function onDelete(zip) {
    statusEl.textContent = '';
    const { error } = await client.rpc('delete_company_zipcode', { p_zip: zip });
    if (error) { toastErr(error.message); return; }
    toastOk(`Deleted ${zip}`);
    await loadZips();
  }

  async function onAdd() {
    statusEl.textContent = '';
    const input = document.getElementById('zipInput');
    const zip = (input.value || '').trim();

    if (!/^[0-9]{5}$/.test(zip)) {
      toastErr('ZIP must be exactly 5 digits');
      return;
    }

    const { error } = await client.rpc('upsert_company_zipcode', { p_zip: zip });
    if (error) { toastErr(error.message); return; }
    input.value = '';
    toastOk(`Saved ${zip}`);
    await loadZips();
  }

  document.getElementById('addBtn').addEventListener('click', onAdd);
  document.getElementById('zipInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') onAdd(); });
</script>
</body>
</html>
