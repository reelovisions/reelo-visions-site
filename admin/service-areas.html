<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Service Areas | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:#0e1525; color:#e9eefc; }
    .wrap { max-width: 1024px; margin: 0 auto; padding: 24px; }
    .card { background: #111a2e; border:1px solid #23314f; border-radius: 14px; padding: 20px; margin: 18px 0; }
    h1 { font-size: 28px; margin: 8px 0 20px; }
    h2 { font-size: 20px; margin: 8px 0 12px; }
    label { font-size:14px; opacity:.85; display:block; margin-bottom:6px;}
    input, select, button { font:inherit; }
    input, select { width: 100%; padding: 10px 12px; border-radius:10px; border:1px solid #314568; background:#0b1324; color:#e9eefc; }
    input::placeholder { color:#7f8fb3; }
    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .col-3 { grid-column: span 3; } .col-4{grid-column:span 4;} .col-6{grid-column:span 6;} .col-9{grid-column:span 9;} .col-12{grid-column:span 12;}
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { background:#2a66ff; border: none; padding: 10px 14px; border-radius:10px; color:white; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn.outline { background:transparent; border:1px solid #345; color:#cfe; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid #1f2942; }
    .muted { color:#9db1d7; font-size: 14px; }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2f4267; background:#0b1324; }
    .toast { position:fixed; right:16px; bottom:16px; background:#0b1324; border:1px solid #2f4267; color:#e9eefc; padding:12px 14px; border-radius:10px; box-shadow: 0 10px 30px rgba(0,0,0,.35); display:none;}
    a { color:#9dc2ff; text-decoration:none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>Service Areas</h1>

    <!-- POLICIES -->
    <div class="card">
      <h2>Policies</h2>
      <div class="row">
        <span class="muted">Enforce service ZIPs</span>
        <label class="pill"><input id="enforceZipToggle" type="checkbox" /> <span>Require ZIP list</span></label>
      </div>
      <p class="muted" style="margin-top:6px">If ON, new appointments must match your ZIP list.</p>
      <div id="policyMeta" class="muted"></div>
    </div>

    <!-- HQ & RADIUS -->
    <div class="card">
      <h2>HQ Location & Radius</h2>
      <div class="grid">
        <div class="col-6">
          <label>Street</label>
          <input id="street" placeholder="123 Main St" />
        </div>
        <div class="col-3">
          <label>City</label>
          <input id="city" placeholder="McKinney" />
        </div>
        <div class="col-1">
          <label>State</label>
          <input id="state" placeholder="TX" />
        </div>
        <div class="col-2">
          <label>ZIP</label>
          <input id="hqzip" placeholder="75071" />
        </div>

        <div class="col-3">
          <label>Radius (miles)</label>
          <input id="radius" type="number" value="25" />
        </div>
        <div class="col-3" style="align-self:end">
          <button id="btnSetHQ" class="btn">Set location (from ZIP)</button>
        </div>
      </div>
      <p id="hqMeta" class="muted" style="margin-top:8px"></p>
    </div>

    <!-- ZIP CODES -->
    <div class="card">
      <h2>ZIP Codes</h2>
      <div class="row" style="margin-bottom:10px">
        <input id="zipInput" style="width:240px" placeholder="e.g. 55401" />
        <button id="btnAddZip" class="btn">Add</button>
      </div>
      <table>
        <thead>
          <tr><th>ZIP</th><th style="width:120px">Action</th></tr>
        </thead>
        <tbody id="zipsBody"><tr><td colspan="2" class="muted">Loading…</td></tr></tbody>
      </table>
    </div>

    <p id="status" class="muted"></p>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ====== 1) FILL THESE IN ====== */
const SUPABASE_URL      = 'https://yvjwajopxbcaedzofqww.supabase.co';  // <-- change
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2andham9weGJjYWVkem9mcXd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODk0NjQsImV4cCI6MjA3NDk2NTQ2NH0.1VVEkgThCltfebpCWa-4DReb9qSO5zdt2a_83CfsBsY';                     // <-- change
const COMPANY_ID        = 'a105e900-8f47-4e1c-b0b6-c126cb904252'; // your UUID

/* ====== 2) RPC names that exist in YOUR DB ====== */
const RPC = {
  listZips:               'get_company_zips',                 // ()
  addZip:                 'add_company_zip',                  // (p_zip text)
  deleteZip:              'delete_company_zip',               // (p_zip text)
  setFromZip:             'set_company_location_from_zip',    // (p_zip text, p_radius_miles int, p_hq_address text)
  setEnforceZip:          'set_company_enforce_zip',          // (p_value boolean)
  getZipCentroid:         'get_zip_centroid'                  // (p_zip text)
};

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Small helpers */
const $ = (id) => document.getElementById(id);
const out = (m) => $('status').textContent = m;
const toast = (m) => { const t = $('toast'); t.textContent = m; t.style.display='block'; setTimeout(()=>t.style.display='none', 3800); };
const zipClean = (z) => (z || '').replace(/\D/g,'').padStart(5,'0').slice(0,5);

/* Ensure we have a session and set the company id in the session */
async function ensureSessionAndCompany() {
  let { data: { session } } = await sb.auth.getSession();
  if (!session) {
    // if you have real auth, you can remove the anon sign-in below
    const { error } = await sb.auth.signInAnonymously();
    if (error) { toast('Auth error: ' + error.message); throw error; }
  }
  // set session config used by the RPCs
  // If you adopted a trigger that sets this automatically, you can skip this
  const { error: cfgErr } = await sb.rpc('set_config', { p_key: 'app.company_id', p_value: COMPANY_ID });
  if (cfgErr) {
    // If you do not have set_config helper, you can create it; or set via SQL page / set-company.html
    // We continue anyway because some of your functions might not need it.
    console.warn('set_config failed:', cfgErr.message);
  }
}

/* Load existing zips */
async function loadZips() {
  const body = {};
  const { data, error, status } = await sb.rpc(RPC.listZips, body);
  if (error) { console.error(error); $('zipsBody').innerHTML = `<tr><td colspan="2" class="muted">Could not load ZIPs.</td></tr>`; return; }
  if (!data || !data.length) { $('zipsBody').innerHTML = `<tr><td colspan="2" class="muted">No ZIPs yet.</td></tr>`; return; }
  $('zipsBody').innerHTML = data.map(r => {
    const z = r.zip ?? r.p_zip ?? r?.[0] ?? ''; // be tolerant about return shape
    return `<tr>
      <td>${z}</td>
      <td><button class="btn outline" data-del="${z}">Delete</button></td>
    </tr>`;
  }).join('');
}

/* Add a zip */
async function addZip() {
  const z = zipClean($('zipInput').value);
  if (!/^\d{5}$/.test(z)) { toast('ZIP must be 5 digits.'); return; }
  const { error, status } = await sb.rpc(RPC.addZip, { p_zip: z });
  if (error) { toast(`Add ZIP failed: ${error.message}`); return; }
  $('zipInput').value = '';
  await loadZips();
}

/* Delete a zip (event delegation) */
$('zipsBody').addEventListener('click', async (e) => {
  const btn = e.target.closest('button[data-del]');
  if (!btn) return;
  const z = btn.getAttribute('data-del');
  const { error } = await sb.rpc(RPC.deleteZip, { p_zip: z });
  if (error) { toast(`Delete ZIP failed: ${error.message}`); return; }
  await loadZips();
});

/* Toggle enforce ZIP */
$('enforceZipToggle').addEventListener('change', async (e) => {
  const val = !!e.target.checked;
  const { error } = await sb.rpc(RPC.setEnforceZip, { p_value: val });
  if (error) { toast('Save policy failed: ' + error.message); return; }
  toast('Policy saved.');
});

/* Set HQ from ZIP + radius */
$('btnSetHQ').addEventListener('click', async () => {
  const addr = `${$('street').value || ''}, ${$('city').value || ''}, ${$('state').value || ''} ${$('hqzip').value || ''}`.trim();
  const z = zipClean($('hqzip').value);
  const miles = parseInt($('radius').value || '0', 10) || 0;
  const { data, error } = await sb.rpc(RPC.setFromZip, { p_zip: z, p_radius_miles: miles, p_hq_address: addr || null });
  if (error) { toast('Set HQ failed: ' + error.message); return; }
  toast('HQ saved.');
});

/* Init */
(async () => {
  out('Working…');
  try {
    await ensureSessionAndCompany();
    await loadZips();
    out('');
  } catch (e) {
    out(e.message || String(e));
  }
})();

</script><script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  // TODO: put YOUR values here
  const SUPABASE_URL  = 'https://yvjwajopxbcaedzofqww.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9....'; // your anon key
  const COMPANY_ID    = 'a105e900-8f47-4e1c-b0b6-c126cb904252';    // your company UUID

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  async function ensureSession() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      const { error } = await supabase.auth.signInAnonymously();
      if (error) throw new Error('Anon sign-in failed: ' + error.message);
    }
  }

  // Set the per-request session key your RPCs expect
  async function setCompanyForSession() {
    const { error } = await supabase.rpc('set_config', {
      p_key: 'app.company_id',
      p_value: COMPANY_ID
    });
    if (error) throw new Error('set_config failed: ' + error.message);
  }

  async function loadZips() {
    const { data, error } = await supabase.rpc('get_company_zips'); // no args
    if (error) { console.error('loadZips error:', error); return; }
    console.log('ZIPs:', data);
    // TODO: render rows into your table
  }

  // Hook up your “Add” button
  document.getElementById('addBtn')?.addEventListener('click', async () => {
    const input = document.getElementById('zipInput');
    const raw   = (input?.value || '').trim();
    const zip   = raw.replace(/\D/g, '').padStart(5, '0'); // keep digits, 5 chars

    if (zip.length !== 5) { alert('ZIP must be 5 digits'); return; }

    const { error } = await supabase.rpc('add_company_zip', { p_zip: zip });
    if (error) { alert('Add ZIP failed: ' + error.message); return; }

    input.value = '';
    await loadZips();
  });

  // --- On page load ---
  (async () => {
    try {
      await ensureSession();
      await setCompanyForSession();
      await loadZips();
    } catch (e) {
      console.error(e);
      alert(e.message);
    }
  })();
</script>

</body>
</html>
