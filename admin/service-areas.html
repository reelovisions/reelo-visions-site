<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Service Areas | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://rsms.me/inter/inter.css" rel="stylesheet">
  <style>
    :root { --fg:#0f172a; --muted:#64748b; --line:#e2e8f0; --brand:#2563eb; --bg:#fff; --chip:#f8fafc; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin:0; color:var(--fg); background:#fafafa; }
    .wrap { max-width: 960px; margin: 32px auto; padding: 0 16px; }
    header { display:flex; gap:20px; align-items:center; margin-bottom:24px; }
    nav a { text-decoration:none; color:var(--muted); font-weight:600; margin-right:16px; }
    nav a.active { color:var(--fg); }
    h1 { font-size: 32px; margin: 0 0 8px; }
    h2.section { font-size:20px; margin:24px 0 12px; }
    .card { background:var(--bg); border:1px solid var(--line); border-radius:12px; padding:18px; margin:16px 0; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .muted { color:var(--muted); font-size:14px; }
    label.switch { display:inline-flex; align-items:center; gap:10px; }
    input[type="checkbox"] { width:42px; height:24px; accent-color:var(--brand); }
    input[type="text"], input[type="number"], select { padding:10px 12px; border:1px solid var(--line); border-radius:10px; font:inherit; background:#fff; }
    button { padding:10px 14px; border:1px solid var(--line); background:var(--chip); border-radius:10px; cursor:pointer; font-weight:600; }
    button.primary { background:var(--brand); border-color:var(--brand); color:#fff; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:12px; border-bottom:1px solid var(--line); vertical-align:top; }
    .right { text-align:right; }
    .pill { display:inline-block; padding:2px 8px; background:var(--chip); border:1px solid var(--line); border-radius:999px; font-size:12px; }
    .status { margin-top:12px; white-space:pre-wrap; }
    .ok { color:#16a34a; }
    .err { color:#b91c1c; }
    .attrib { font-size:12px; color:var(--muted); margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 style="margin-right:auto;">Service Areas</h1>
      <nav>
        <a href="/admin/" id="navDash">Dashboard</a>
        <a href="/admin/service-areas.html" class="active">Service Areas</a>
        <a href="#" id="logout">Logout</a>
      </nav>
    </header>

    <!-- Policies -->
    <div class="card">
      <h2 class="section">Policies</h2>

      <div class="row" style="margin:8px 0;">
        <label class="switch">
          <input type="checkbox" id="enforceZip">
          <strong>Enforce service ZIPs</strong>
        </label>
        <span class="muted">If ON, new appointments must match your ZIP list.</span>
      </div>

      <div class="row" style="margin:8px 0;">
        <label class="switch">
          <input type="checkbox" id="enforceRadius">
          <strong>Enforce radius from HQ</strong>
        </label>
        <span class="muted">If ON, bookings must be within your radius from HQ lat/lon.</span>
      </div>

      <div class="muted" id="policySummary">ZIPS: OFF · Radius: OFF</div>
    </div>

    <!-- HQ + Radius -->
    <div class="card">
      <h2 class="section">HQ Location &amp; Radius</h2>
      <div class="row">
        <input id="hqAddress" type="text" placeholder="123 Main St, City, ST ZIP" style="min-width:350px; flex:1;">
        <button id="geocodeBtn">Set location (geocode)</button>
        <input id="radiusMiles" type="number" min="1" step="1" value="25" style="width:100px;">
        <button class="primary" id="saveRadiusBtn">Save radius</button>
      </div>
      <div class="muted" id="hqMeta">HQ: not set</div>
      <div class="muted" id="geoStatus"></div>
      <div class="attrib">Geocoding by <a href="https://nominatim.openstreetmap.org/" target="_blank">Nominatim</a> / © OpenStreetMap contributors.</div>
    </div>

    <!-- ZIP CRUD -->
    <div class="card">
      <h2 class="section">ZIP Codes</h2>
      <div class="row">
        <input id="zipInput" type="text" pattern="\\d{5}" maxlength="5" placeholder="e.g. 55401">
        <button class="primary" id="addBtn">Add</button>
      </div>
      <div class="muted">Must be exactly 5 digits. Duplicate adds are ignored (upsert).</div>

      <table>
        <thead><tr><th>ZIP</th><th class="right" style="width:120px;">Action</th></tr></thead>
        <tbody id="zipsBody"></tbody>
      </table>
    </div>

    <div id="status" class="status"></div>
  </div>

  <!-- Supabase -->
  <script type="module">
    // ---------- Config (edit these two lines only) ----------
    const SUPABASE_URL = 'https://yvjwajopxbcaedzofqww.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2andham9weGJjYWVkem9mcXd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODk0NjQsImV4cCI6MjA3NDk2NTQ2NH0.1VVEkgThCltfebpCWa-4DReb9qSO5zdt2a_83CfsBsY';
    const GEOCODE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/geocode`;
    // -------------------------------------------------------

    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // ---- helpers
    const qs = sel => document.querySelector(sel);
    const status = qs('#status');
    const notify = (msg, ok=true) => {
      status.innerText = msg;
      status.className = 'status ' + (ok ? 'ok':'err');
    };
    const fmtBool = b => b ? 'ON' : 'OFF';

    // ---- auth guard + initial load
    async function requireSession() {
      const { data: { session } } = await client.auth.getSession();
      if (!session) {
        location.href = '/admin/login.html';
        return null;
      }
      return session;
    }

    async function loadSettings() {
      // Expect the RLS-safe settings for the current company
      const { data, error } = await client.rpc('get_company_settings');
      if (error) { notify(`Load settings failed: ${error.message}`, false); return; }
      const s = data || {};
      // toggles
      qs('#enforceZip').checked = !!s.enforce_zip;
      qs('#enforceRadius').checked = !!s.enforce_radius;
      // summary
      qs('#policySummary').innerText = `ZIPS: ${fmtBool(!!s.enforce_zip)} · Radius: ${fmtBool(!!s.enforce_radius)}`;
      // HQ + radius
      const hqBits = (s.base_address || s.base_city || s.base_state || s.base_zip)
        ? `${s.base_address ?? ''} ${s.base_city ?? ''}, ${s.base_state ?? ''} ${s.base_zip ?? ''}`.replace(/\s+/g,' ').trim()
        : null;
      const lat = s.hq_lat, lon = s.hq_lon;
      qs('#radiusMiles').value = s.radius_miles ?? 25;
      qs('#hqMeta').innerText = hqBits
        ? `HQ: ${hqBits} → lat=${lat ?? '—'}, lon=${lon ?? '—'} · radius=${s.radius_miles ?? '—'} mi`
        : `HQ: not set`;
    }

    async function loadZips() {
      const { data, error } = await client
        .from('company_zipcodes')
        .select('zipcode')
        .order('zipcode', { ascending: true });

      const tbody = qs('#zipsBody');
      tbody.innerHTML = '';

      if (error) {
        notify(`Load ZIPs failed: ${error.message}`, false);
        return;
      }
      if (!data || data.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="muted">No ZIPs yet.</td><td></td>`;
        tbody.appendChild(tr);
        return;
      }
      for (const row of data) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${row.zipcode}</strong></td>
          <td class="right"><button data-zip="${row.zipcode}" class="delBtn">Delete</button></td>
        `;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll('.delBtn').forEach(btn => {
        btn.addEventListener('click', async () => {
          btn.disabled = true;
          const zip = btn.getAttribute('data-zip');
          const { error } = await client.rpc('delete_company_zipcode', { p_zipcode: zip });
          if (error) notify(`Delete ${zip} failed: ${error.message}`, false);
          else notify(`Deleted ${zip}`);
          await loadZips();
          btn.disabled = false;
        });
      });
    }

    // ---- wire UI actions
    qs('#logout').addEventListener('click', async (e) => {
      e.preventDefault();
      await client.auth.signOut();
      location.href = '/admin/login.html';
    });

    qs('#enforceZip').addEventListener('change', async (e) => {
      const val = !!e.target.checked;
      e.target.disabled = true;
      const { error } = await client.rpc('set_company_enforce_zip', { p_value: val });
      if (error) { notify(`Update failed: ${error.message}`, false); }
      else { notify(`ZIP enforcement: ${fmtBool(val)}`); }
      e.target.disabled = false;
      loadSettings();
    });

    qs('#enforceRadius').addEventListener('change', async (e) => {
      const val = !!e.target.checked;
      e.target.disabled = true;
      const { error } = await client.rpc('set_company_enforce_radius', { p_value: val });
      if (error) { notify(`Update failed: ${error.message}`, false); }
      else { notify(`Radius enforcement: ${fmtBool(val)}`); }
      e.target.disabled = false;
      loadSettings();
    });

    qs('#saveRadiusBtn').addEventListener('click', async () => {
      const miles = Number(qs('#radiusMiles').value || 0);
      const { error } = await client.rpc('set_company_radius', { p_radius_miles: miles });
      if (error) { notify(`Save radius failed: ${error.message}`, false); return; }
      notify(`Radius saved: ${miles} miles`);
      loadSettings();
    });

    qs('#geocodeBtn').addEventListener('click', async () => {
      const addr = qs('#hqAddress').value.trim();
      if (!addr) { notify('Enter an address to geocode.', false); return; }
      qs('#geoStatus').innerText = 'Geocoding...';

      // Call your Edge Function (public CORS, no auth needed)
      const r = await fetch(GEOCODE_FUNCTION_URL, {
        method: 'POST',
        headers: { 'content-type': 'application/json', 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
        body: JSON.stringify({ address: addr })
      }).catch(() => null);

      if (!r) { qs('#geoStatus').innerText = 'Failed to fetch'; return; }
      if (!r.ok) { qs('#geoStatus').innerText = `Geocode failed: HTTP ${r.status}`; return; }

      const gj = await r.json();
      const { lat, lon, normalized } = gj || {};
      if (typeof lat !== 'number' || typeof lon !== 'number') {
        qs('#geoStatus').innerText = 'No results for address';
        return;
      }

      // Persist to company settings
      const { error } = await client.rpc('set_company_location', {
        p_hq_address: normalized || addr,
        p_hq_lat: lat,
        p_hq_lon: lon
      });

      if (error) { qs('#geoStatus').innerText = `Save failed: ${error.message}`; }
      else {
        qs('#geoStatus').innerText = `OK: ${normalized || addr} → lat=${lat.toFixed(6)}, lon=${lon.toFixed(6)}`;
        loadSettings();
      }
    });

    qs('#addBtn').addEventListener('click', async () => {
      const zip = qs('#zipInput').value.trim();
      if (!/^\d{5}$/.test(zip)) { notify('ZIP must be exactly 5 digits.', false); return; }
      const { error } = await client.rpc('upsert_company_zipcode', { p_zipcode: zip });
      if (error) { notify(`Add ZIP failed: ${error.message}`, false); }
      else { notify(`Added ${zip}`); qs('#zipInput').value=''; }
      loadZips();
    });

    // ---- boot
    (async () => {
      const session = await requireSession();
      if (!session) return;
      await Promise.all([loadSettings(), loadZips()]);
    })();
  </script>
</body>
</html>
