<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Service Areas | Admin</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    :root { --fg:#0f172a; --muted:#64748b; --border:#e2e8f0; --bg:#fff; --link:#2563eb; --card:#ffffff }
    body{margin:0;background:#f8fafc;color:var(--fg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--link);text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:28px 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{font-size:28px;font-weight:800}
    nav a{margin-right:20px;font-weight:600}
    nav a.active{color:#111}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;margin:16px 0}
    .row{display:flex;gap:12px;align-items:center}
    .muted{color:var(--muted);font-size:14px}
    .attrib{font-size:12px;color:var(--muted);margin-top:4px}
    hr.sep{border:none;border-top:1px solid var(--border);margin:18px 0}

    /* Table */
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:12px;border-top:1px solid var(--border);text-align:left}
    th{font-size:14px;color:var(--muted);font-weight:700}

    /* Buttons / inputs */
    input[type="text"], input[type="number"]{
      padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none;width:100%;
    }
    button.primary{
      background:#2563eb;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer
    }
    button.ghost{
      background:#fff;color:#111;border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer
    }
    button.small{padding:6px 10px;border-radius:8px;font-size:14px}

    /* Toggle slider */
    .policy-row{display:flex;gap:12px;align-items:center;margin:12px 0}
    .policy-text{display:flex;flex-direction:column}
    .policy-title{font-weight:800}
    .toggle{position:relative;display:inline-block;width:48px;height:28px;cursor:pointer}
    .toggle input{opacity:0;width:0;height:0}
    .slider{position:absolute;inset:0;background:#e2e8f0;border-radius:999px;transition:all .2s}
    .slider:before{content:"";position:absolute;height:22px;width:22px;left:3px;top:3px;background:#fff;border-radius:50%;box-shadow:0 1px 2px rgba(0,0,0,.15);transition:all .2s}
    .toggle input:checked + .slider{background:#2563eb}
    .toggle input:checked + .slider:before{transform:translateX(20px)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Service Areas</div>
      <nav>
        <a href="/admin/">Dashboard</a>
        <a href="/admin/service-areas.html" class="active">Service Areas</a>
        <a href="#" id="logoutLink">Logout</a>
      </nav>
    </header>

    <!-- Policies -->
    <div class="card">
      <h2 style="margin:0 0 12px;">Policies</h2>

      <div class="policy-row">
        <label class="toggle" title="If ON, new appointments must match your ZIP list.">
          <input id="enforceZip" type="checkbox" />
          <span class="slider"></span>
        </label>
        <div class="policy-text">
          <div class="policy-title">Enforce service ZIPs</div>
          <div class="muted">If ON, new appointments must match your ZIP list.</div>
        </div>
      </div>

      <div class="policy-row">
        <label class="toggle" title="If ON, bookings must be within your radius from HQ lat/lon.">
          <input id="enforceRadius" type="checkbox" />
          <span class="slider"></span>
        </label>
        <div class="policy-text">
          <div class="policy-title">Enforce radius from HQ</div>
          <div class="muted">If ON, bookings must be within your radius from HQ lat/lon.</div>
        </div>
      </div>

      <div class="muted" id="policySummary">ZIPS: OFF · Radius: OFF</div>
    </div>

    <!-- HQ + Radius -->
    <div class="card">
      <h2 style="margin:0 0 12px;">HQ Location & Radius</h2>
      <div class="row" style="gap:10px;align-items:stretch">
        <input id="hqAddress" type="text" placeholder="123 Main St, City, ST ZIP" />
        <button id="geocodeBtn" class="ghost">Set location (geocode)</button>
        <input id="radiusInput" type="number" step="1" min="1" style="width:120px" value="25" />
        <button id="saveRadiusBtn" class="primary">Save radius</button>
      </div>
      <div id="hqMeta" class="muted" style="margin-top:8px;">HQ: not set</div>
      <div id="geoStatus" class="muted" style="margin-top:4px;"></div>
      <div class="attrib">Geocoding by <a href="https://nominatim.openstreetmap.org/" target="_blank">Nominatim</a> / © OpenStreetMap contributors.</div>
    </div>

    <!-- ZIP CRUD -->
    <div class="card">
      <h2 style="margin:0 0 12px;">ZIP Codes</h2>
      <div class="row" style="gap:10px;align-items:center">
        <input id="zipInput" type="text" pattern="\\d{5}" maxlength="5" placeholder="e.g. 55401" style="width:240px" />
        <button id="addBtn" class="primary">Add</button>
      </div>
      <div class="muted" style="margin-top:6px">Must be exactly 5 digits. Duplicate adds are ignored (upsert).</div>

      <table id="zipsTable">
        <thead>
          <tr><th>ZIP</th><th style="width:120px;">Action</th></tr>
        </thead>
        <tbody id="zipsBody"></tbody>
      </table>
      <div id="status" class="muted"></div>
    </div>
  </div>

  <script type="module">
    // ========= Config (uses same values as your other admin pages) =========
    const SUPABASE_URL = 'https://yvjwajopxbcaedzofqww.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2andham9weGJjYWVkem9mcXd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODk0NjQsImV4cCI6MjA3NDk2NTQ2NH0.1VVEkgThCltfebpCWa-4DReb9qSO5zdt2a_83CfsBsY';
    const GEOCODE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/geocode`;

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========= Auth guard =========
    const { data: { session } } = await client.auth.getSession();
    if (!session) location.href = '/admin/login.html';

    document.getElementById('logoutLink').addEventListener('click', async (e) => {
      e.preventDefault();
      await client.auth.signOut();
      location.href = '/admin/login.html';
    });

    // ========= Elements =========
    const elZip   = document.getElementById('enforceZip');
    const elRad   = document.getElementById('enforceRadius');
    const summary = document.getElementById('policySummary');

    const zipInput = document.getElementById('zipInput');
    const addBtn   = document.getElementById('addBtn');
    const zipsBody = document.getElementById('zipsBody');
    const statusEl = document.getElementById('status');

    const hqAddress = document.getElementById('hqAddress');
    const geocodeBtn = document.getElementById('geocodeBtn');
    const radiusInput = document.getElementById('radiusInput');
    const saveRadiusBtn = document.getElementById('saveRadiusBtn');
    const hqMeta = document.getElementById('hqMeta');
    const geoStatus = document.getElementById('geoStatus');

    function toast(msg){
      statusEl.textContent = msg;
      setTimeout(()=>{ statusEl.textContent = '' }, 3000);
    }
    function renderSummary() {
      summary.textContent = `ZIPS: ${elZip.checked ? 'ON' : 'OFF'} · Radius: ${elRad.checked ? 'ON' : 'OFF'}`;
    }

    // ========= Policy toggles =========
    elZip.addEventListener('change', async () => {
      elZip.disabled = true;
      const { error } = await client.rpc('set_company_enforce_zip', { p_value: elZip.checked });
      if (error) { console.error(error); toast(`Error: ${error.message}`); elZip.checked = !elZip.checked; }
      elZip.disabled = false; renderSummary();
    });

    elRad.addEventListener('change', async () => {
      elRad.disabled = true;
      const { error } = await client.rpc('set_company_enforce_radius', { p_value: elRad.checked });
      if (error) { console.error(error); toast(`Error: ${error.message}`); elRad.checked = !elRad.checked; }
      elRad.disabled = false; renderSummary();
    });

    async function loadSettings() {
      const { data, error } = await client.rpc('get_company_settings');
      if (error) { console.error(error); toast(`Error: ${error.message}`); return; }

      elZip.checked = !!data.enforce_zip;
      elRad.checked = !!data.enforce_radius;
      renderSummary();

      // Show HQ meta if we have it
      const parts = [];
      if (data.base_address) parts.push(data.base_address);
      if (data.base_city) parts.push(data.base_city);
      if (data.base_state) parts.push(data.base_state);
      if (data.base_zip) parts.push(data.base_zip);
      const addrLine = parts.filter(Boolean).join(', ');
      const ll = (data.hq_lat && data.hq_lon) ? ` → lat=${Number(data.hq_lat).toFixed(6)}, lon=${Number(data.hq_lon).toFixed(6)}` : '';
      const rad = (data.radius_miles != null) ? ` · radius=${data.radius_miles} mi` : '';
      hqMeta.textContent = addrLine ? `HQ: ${addrLine}${ll}${rad}` : 'HQ: not set';

      if (data.radius_miles != null) radiusInput.value = data.radius_miles;
    }

    // ========= ZIP CRUD =========
    async function refreshZips() {
      zipsBody.innerHTML = '';
      const { data, error } = await client
        .from('company_zipcodes')
        .select('zipcode')
        .order('zipcode', { ascending: true });
      if (error) { console.error(error); toast(`Error: ${error.message}`); return; }

      if (!data || !data.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="2" class="muted">No ZIPs yet.</td>`;
        zipsBody.appendChild(tr);
        return;
      }

      for (const row of data) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.zipcode}</td>
          <td><button class="ghost small" data-zip="${row.zipcode}">Delete</button></td>
        `;
        zipsBody.appendChild(tr);
      }

      zipsBody.querySelectorAll('button[data-zip]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const z = btn.getAttribute('data-zip');
          btn.disabled = true;
          const { error } = await client.rpc('delete_company_zipcode', { p_zip: z });
          if (error) { console.error(error); toast(`Error: ${error.message}`); }
          await refreshZips();
        });
      });
    }

    addBtn.addEventListener('click', async () => {
      const z = (zipInput.value || '').trim();
      if (!/^\d{5}$/.test(z)) { toast('ZIP must be exactly 5 digits.'); return; }
      addBtn.disabled = true;
      const { error } = await client.rpc('upsert_company_zipcode', { p_zip: z });
      if (error) { console.error(error); toast(`Error: ${error.message}`); }
      addBtn.disabled = false;
      zipInput.value = '';
      await refreshZips();
    });

    // ========= HQ + Radius =========
    geocodeBtn.addEventListener('click', async () => {
      const addr = (hqAddress.value || '').trim();
      if (!addr) { toast('Enter an address first.'); return; }
      geoStatus.textContent = 'Geocoding...';
      try {
        const r = await fetch(GEOCODE_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'content-type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ address: addr })
        });
        const body = await r.json().catch(() => ({}));
        if (!r.ok) { geoStatus.textContent = `Geocode failed: HTTP ${r.status}`; console.error(body); return; }
        const { lat, lon } = body || {};
        if (typeof lat !== 'number' || typeof lon !== 'number') { geoStatus.textContent = 'No results for address'; return; }

        const miles = Number(radiusInput.value || 25);
        const { error } = await client.rpc('set_company_location', {
          p_hq_address: addr,
          p_hq_lat: lat,
          p_hq_lon: lon,
          p_radius_miles: miles
        });
        if (error) { geoStatus.textContent = error.message; console.error(error); return; }
        geoStatus.textContent = 'Saved HQ lat/lon + radius.';
        await loadSettings();
      } catch (e) {
        geoStatus.textContent = 'Failed to fetch';
        console.error(e);
      }
    });

    saveRadiusBtn.addEventListener('click', async () => {
      const miles = Number(radiusInput.value || 25);
      const { error } = await client.rpc('set_company_radius_miles', { p_miles: miles });
      if (error) { toast(error.message); return; }
      toast('Radius saved.');
      await loadSettings();
    });

    // ========= Init =========
    await loadSettings();
    await refreshZips();
  </script>
</body>
</html>
