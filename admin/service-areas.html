<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Service Areas | Admin</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --muted:#a7b0c3;
      --text:#e8eefc;
      --brand:#4f8cff;
      --brand-2:#22c55e;
      --border:rgba(255,255,255,.08);
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#0b1020 0%,#0f1b3a 100%);
      font-family:Inter,system-ui,ui-sans-serif,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
      color:var(--text);
    }
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:20px;margin-bottom:16px}
    header h1{margin:0;font-size:28px;font-weight:800;letter-spacing:.2px}
    nav a{color:var(--muted);text-decoration:none;margin-right:16px}
    nav a.active{color:var(--text);font-weight:600}
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px 18px 8px 18px;
      box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
      margin-bottom:16px;
    }
    h2{font-size:18px;margin:0 0 12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"],input[type="number"]{
      background:#0c1430;
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:10px 12px;
      outline:none;
      width:100%;
    }
    input[type="number"]{max-width:120px}
    .btn{
      background:var(--brand);
      color:#fff;
      border:0;
      border-radius:10px;
      padding:10px 14px;
      font-weight:600;
      cursor:pointer;
    }
    .btn.secondary{background:#16224a}
    .btn.success{background:var(--brand-2)}
    .btn.danger{background:var(--danger)}
    .muted{color:var(--muted);font-size:13px}
    .status{margin-top:8px;font-size:13px}
    hr{border:0;border-top:1px solid var(--border);margin:16px 0}

    /* switch */
    .switch{position:relative;width:52px;height:28px}
    .switch input{display:none}
    .slider{
      position:absolute;cursor:pointer;inset:0;background:#0c1430;border:1px solid var(--border);
      transition:.2s;border-radius:999px;
    }
    .slider:before{
      position:absolute;content:"";height:22px;width:22px;left:3px;top:3px;background:#fff;border-radius:999px;transition:.2s;
    }
    input:checked + .slider{background:linear-gradient(90deg,#2563eb,#22c55e)}
    input:checked + .slider:before{transform:translateX(24px)}
    .row.mid{align-items:flex-end}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 6px;border-top:1px solid var(--border);font-size:14px}
    th{color:var(--muted);text-align:left}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0c1430;border:1px solid var(--border);font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Service Areas</h1>
      <nav>
        <a href="/admin/" >Dashboard</a>
        <a href="/admin/service-areas.html" class="active">Service Areas</a>
        <a href="/admin/new-appointment.html">New Appointment</a>
        <a href="/admin/login.html" id="logoutLink">Logout</a>
      </nav>
    </header>

    <!-- Policies -->
    <div class="card">
      <h2>Policies</h2>
      <div class="row">
        <div>
          <label>Enforce service ZIPs</label>
          <label class="switch">
            <input id="enforceZip" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>
        <div class="muted">If ON, new appointments must match your ZIP list.</div>
      </div>
      <div class="row" style="margin-top:12px">
        <div>
          <label>Enforce radius from HQ</label>
          <label class="switch">
            <input id="enforceRadius" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>
        <div class="muted">If ON, bookings must be within your radius from HQ lat/lon.</div>
      </div>
      <div class="muted" id="policyMeta" style="margin-top:10px">—</div>
    </div>

    <!-- HQ + Radius -->
    <div class="card">
      <h2>HQ Location & Radius</h2>
      <div class="row mid">
        <div style="flex:1;min-width:220px">
          <label>Company (optional)</label>
          <input id="hqCompany" type="text" placeholder="Acme Heating & Cooling">
        </div>
        <div style="flex:2;min-width:220px">
          <label>Street</label>
          <input id="hqStreet" type="text" placeholder="123 Main St">
        </div>
        <div style="flex:1;min-width:160px">
          <label>City</label>
          <input id="hqCity" type="text" placeholder="McKinney">
        </div>
        <div style="flex:0.5;min-width:100px">
          <label>State</label>
          <input id="hqState" type="text" placeholder="TX">
        </div>
        <div style="flex:0.8;min-width:120px">
          <label>ZIP</label>
          <input id="hqZip" type="text" placeholder="75071">
        </div>
        <div>
          <button class="btn secondary" id="geocodeBtn">Set location (geocode)</button>
        </div>
        <div>
          <label>Radius (miles)</label>
          <input id="radiusMiles" type="number" min="0" step="1" value="25">
        </div>
        <div>
          <button class="btn" id="saveRadiusBtn">Save radius</button>
        </div>
      </div>
      <div class="muted" id="hqMeta" style="margin-top:10px">HQ: not set</div>
      <div class="status" id="geoStatus"></div>
    </div>

    <!-- ZIPs -->
    <div class="card">
      <h2>ZIP Codes</h2>
      <div class="row">
        <div style="flex:1;min-width:220px">
          <label>Add ZIP</label>
          <input id="zipInput" type="text" maxlength="5" pattern="\\d{5}" placeholder="e.g. 55401">
        </div>
        <div>
          <button class="btn" id="addZipBtn">Add</button>
        </div>
      </div>
      <div class="muted">Must be exactly 5 digits. Duplicate adds are ignored (upsert).</div>

      <table>
        <thead><tr><th>ZIP</th><th style="width:120px">Action</th></tr></thead>
        <tbody id="zipsBody"></tbody>
      </table>
      <div class="status" id="status"></div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script type="module">
    // ---------- Config (edit these two lines only) ----------
    const SUPABASE_URL = 'https://yvjwajopxbcaedzofqww.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2andham9weGJjYWVkem9mcXd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODk0NjQsImV4cCI6MjA3NDk2NTQ2NH0.1VVEkgThCltfebpCWa-4DReb9qSO5zdt2a_83CfsBsY';
    const GEOCODE_URL = `${SUPABASE_URL}/functions/v1/geocode`;
    // -------------------------------------------------------

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Elements
    const enforceZipEl = document.getElementById('enforceZip');
    const enforceRadiusEl = document.getElementById('enforceRadius');
    const policyMetaEl = document.getElementById('policyMeta');

    const hqCompany = document.getElementById('hqCompany');
    const hqStreet  = document.getElementById('hqStreet');
    const hqCity    = document.getElementById('hqCity');
    const hqState   = document.getElementById('hqState');
    const hqZip     = document.getElementById('hqZip');
    const geocodeBtn = document.getElementById('geocodeBtn');

    const radiusMiles = document.getElementById('radiusMiles');
    const saveRadiusBtn = document.getElementById('saveRadiusBtn');

    const hqMeta = document.getElementById('hqMeta');
    const geoStatus = document.getElementById('geoStatus');

    const zipInput = document.getElementById('zipInput');
    const addZipBtn = document.getElementById('addZipBtn');
    const zipsBody = document.getElementById('zipsBody');
    const statusEl = document.getElementById('status');

    document.getElementById('logoutLink').addEventListener('click', async (e) => {
      e.preventDefault();
      await client.auth.signOut();
      location.href = '/admin/login.html';
    });

    // Auth guard
    (async () => {
      const { data: { session } } = await client.auth.getSession();
      if (!session) {
        location.href = '/admin/login.html';
        return;
      }
      await loadAll();
    })();

    async function loadAll() {
      await Promise.all([loadSettings(), loadZips()]);
    }

    async function loadSettings() {
      const { data, error } = await client.rpc('get_company_settings');
      if (error) {
        policyMetaEl.textContent = `Settings load failed: ${error.message}`;
        return;
      }
      if (!data) return;

      enforceZipEl.checked = !!data.enforce_zip;
      enforceRadiusEl.checked = !!data.enforce_radius;
      radiusMiles.value = data.radius_miles ?? 25;

      if (data.hq_address && data.hq_lat && data.hq_lon) {
        hqMeta.textContent = `HQ: ${data.hq_address} → lat=${data.hq_lat.toFixed(6)}, lon=${data.hq_lon.toFixed(6)} · radius=${radiusMiles.value} mi`;
      } else {
        hqMeta.textContent = 'HQ: not set';
      }

      policyMetaEl.textContent = `ZIPs: ${enforceZipEl.checked ? 'ON':'OFF'} · Radius: ${enforceRadiusEl.checked ? 'ON':'OFF'}`;
    }

    // Toggle handlers → persist via RPC
    enforceZipEl.addEventListener('change', savePolicy);
    enforceRadiusEl.addEventListener('change', savePolicy);

    async function savePolicy() {
      const { error } = await client.rpc('set_company_enforcement', {
        p_enforce_zip: enforceZipEl.checked,
        p_enforce_radius: enforceRadiusEl.checked
      });
      if (error) {
        policyMetaEl.textContent = `Save failed: ${error.message}`;
      } else {
        policyMetaEl.textContent = `ZIPs: ${enforceZipEl.checked ? 'ON':'OFF'} · Radius: ${enforceRadiusEl.checked ? 'ON':'OFF'}`;
      }
    }

    // Geocode and save HQ
    geocodeBtn.addEventListener('click', async () => {
      geoStatus.textContent = 'Geocoding...';
      const parts = [hqCompany.value, hqStreet.value, hqCity.value, hqState.value, hqZip.value]
        .map(s => (s||'').trim()).filter(Boolean);
      if (parts.length < 3) {
        geoStatus.textContent = 'Please enter at least Street, City, State (ZIP recommended).';
        return;
      }
      const address = parts.join(', ');

      const { data: { session } } = await client.auth.getSession();
      try {
        const r = await fetch(GEOCODE_URL, {
          method: 'POST',
          headers: {
            'content-type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${session?.access_token ?? SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ address })
        });
        if (!r.ok) {
          const t = await r.text();
          geoStatus.textContent = `Geocode failed: HTTP ${r.status}${t ? ' · ' + t : ''}`;
          return;
        }
        const res = await r.json(); // { lat, lon, display_name }
        const { error } = await client.rpc('set_company_location', {
          p_hq_address: res.display_name || address,
          p_hq_lat: Number(res.lat),
          p_hq_lon: Number(res.lon)
        });
        if (error) {
          geoStatus.textContent = `Save HQ failed: ${error.message}`;
        } else {
          geoStatus.textContent = 'HQ saved.';
          await loadSettings();
        }
      } catch (e) {
        geoStatus.textContent = `Geocode error: ${String(e)}`;
      }
    });

    // Save radius
    saveRadiusBtn.addEventListener('click', async () => {
      const miles = Number(radiusMiles.value || 0);
      const { error } = await client.rpc('set_company_radius_miles', { p_miles: miles });
      statusEl.textContent = error ? `Save radius failed: ${error.message}` : 'Radius saved.';
      await loadSettings();
    });

    // ZIP CRUD
    async function loadZips() {
      zipsBody.innerHTML = '';
      const { data, error } = await client.from('company_zipcodes').select('zipcode').order('zipcode');
      if (error) {
        zipsBody.innerHTML = `<tr><td colspan="2">Load failed: ${error.message}</td></tr>`;
        return;
      }
      if (!data || data.length === 0) {
        zipsBody.innerHTML = `<tr><td colspan="2" class="muted">No ZIPs yet.</td></tr>`;
        return;
      }
      for (const row of data) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.zipcode}</td>
          <td><button class="btn danger" data-zip="${row.zipcode}">Delete</button></td>
        `;
        tr.querySelector('button').addEventListener('click', () => deleteZip(row.zipcode));
        zipsBody.appendChild(tr);
      }
    }

    async function deleteZip(zip) {
      const { error } = await client.rpc('delete_company_zipcode', { p_zipcode: zip });
      statusEl.textContent = error ? `Delete failed: ${error.message}` : 'ZIP deleted.';
      await loadZips();
    }

    addZipBtn.addEventListener('click', async () => {
      const z = (zipInput.value || '').trim();
      if (!/^\d{5}$/.test(z)) {
        statusEl.textContent = 'ZIP must be exactly 5 digits.';
        return;
      }
      const { error } = await client.rpc('upsert_company_zipcode', { p_zipcode: z });
      statusEl.textContent = error ? `Add failed: ${error.message}` : 'ZIP added.';
      zipInput.value = '';
      await loadZips();
    });
  </script>
</body>
</html>
