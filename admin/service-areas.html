<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Service Areas | Admin</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--card:#0b1220;--line:#1f2937;--text:#e5eefc;--accent:#60a5fa;--green:#22c55e;--red:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#0b1220 0%,#0a1120 40%,#0f172a 100%);color:var(--text);font:16px/1.4 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--accent);text-decoration:none}
  header{max-width:1100px;margin:24px auto 0;padding:0 16px;display:flex;align-items:center;gap:24px}
  nav a{margin-right:16px;opacity:.9}
  nav a.active{color:#fff;font-weight:700}
  .container{max-width:1100px;margin:12px auto 48px;padding:0 16px}
  h1{font-size:34px;margin:8px 0 20px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.00));border:1px solid var(--line);border-radius:14px;padding:20px;margin:18px 0}
  .section-title{font-weight:700;margin:0 0 14px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
  input,select,button{font:14px/1.2 Inter,system-ui}
  input,select{width:100%;padding:12px 12px;border-radius:10px;background:#0c1323;color:var(--text);border:1px solid #1f2937;outline:none}
  input:focus{border-color:#334155}
  .col-2{flex:1 1 220px}
  .col-3{flex:1 1 160px}
  .muted{color:var(--muted);font-size:13px}
  hr{border:none;border-top:1px solid var(--line);margin:16px 0}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#0c1323;color:var(--text);cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent;color:#001733;font-weight:700}
  .btn.green{background:var(--green);color:#062a10;border-color:transparent;font-weight:700}
  .btn.red{background:#ef4444;color:#2f0b0b;border-color:transparent}
  .inline{display:inline-flex;gap:10px;align-items:center}
  .switch{position:relative;width:46px;height:26px;background:#1f2937;border-radius:999px;border:1px solid #273244;cursor:pointer;vertical-align:middle}
  .switch input{display:none}
  .switch .dot{position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:#334155;transition:.18s all}
  .switch input:checked + .dot{left:22px;background:var(--green)}
  table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{padding:12px;border-bottom:1px solid var(--line)}
  .status{margin-top:10px;font-size:13px}
  .toast{position:fixed;right:16px;bottom:16px;background:#0c1323;color:var(--text);border:1px solid #243045;padding:12px 14px;border-radius:10px;opacity:.98;z-index:50}
</style>
</head>
<body>
  <header>
    <h1>Service Areas</h1>
    <nav>
      <a href="/admin/"    >Dashboard</a>
      <a href="/admin/service-areas.html" class="active">Service Areas</a>
      <a href="/admin/new-appointment.html">New Appointment</a>
      <a href="/admin/login.html" id="logoutLink">Logout</a>
    </nav>
  </header>

  <div class="container">

    <!-- Policies -->
    <div class="card">
      <div class="section-title">Policies</div>

      <div class="row">
        <div class="col-2">
          <label>Enforce service ZIPs</label>
          <label class="switch">
            <input id="enforceZips" type="checkbox">
            <span class="dot"></span>
          </label>
          <span class="muted"> If ON, new appointments must match your ZIP list.</span>
        </div>
        <div class="col-2">
          <label>Enforce radius from HQ</label>
          <label class="switch">
            <input id="enforceRadius" type="checkbox">
            <span class="dot"></span>
          </label>
          <span class="muted"> If ON, bookings must be within your radius from HQ lat/lon.</span>
        </div>
      </div>

      <div id="polSummary" class="muted" style="margin-top:8px;">&nbsp;</div>
    </div>

    <!-- HQ & Radius -->
    <div class="card">
      <div class="section-title">HQ Location & Radius</div>

      <div class="row">
        <div class="col-2">
          <label>Company (optional)</label>
          <input id="hqCompany" placeholder="Company name">
        </div>
        <div class="col-2">
          <label>Street</label>
          <input id="hqStreet" placeholder="123 Main St">
        </div>
        <div class="col-3">
          <label>City</label>
          <input id="hqCity" placeholder="City">
        </div>
        <div class="col-3">
          <label>State</label>
          <input id="hqState" placeholder="MN" maxlength="2">
        </div>
        <div class="col-3">
          <label>ZIP</label>
          <input id="hqZip" placeholder="e.g. 55401" pattern="\\d{5}" maxlength="5">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col-3">
          <button id="geocodeBtn" class="btn">Set location (use ZIP centroid)</button>
        </div>
        <div class="col-3">
          <label>Radius (miles)</label>
          <input id="radiusMiles" value="25">
        </div>
        <div class="col-3" style="align-self:flex-end;">
          <button id="saveRadiusBtn" class="btn primary">Save radius</button>
        </div>
      </div>

      <div id="hqMeta" class="muted" style="margin-top:10px">HQ: not set</div>
      <div id="geoStatus" class="status muted"></div>
    </div>

    <!-- ZIP CRUD -->
    <div class="card">
      <div class="section-title">ZIP Codes</div>
      <div class="row">
        <div class="col-2">
          <input id="zipInput" placeholder="e.g. 55401" maxlength="5" pattern="\\d{5}">
        </div>
        <div class="col-3">
          <button id="addBtn" class="btn primary">Add</button>
        </div>
      </div>
      <div class="muted">Must be exactly 5 digits. Duplicate adds are ignored (upsert).</div>

      <table style="margin-top:12px">
        <thead><tr><th style="width:120px">ZIP</th><th>Action</th></tr></thead>
        <tbody id="zipsBody"></tbody>
      </table>

      <div id="status" class="status muted"></div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script type="module">
  // ---------- Config (confirm these 2 lines) ----------
  const SUPABASE_URL = 'https://yvjwajopxbcaedzofqww.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2andham9weGJjYWVkem9mcXd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODk0NjQsImV4cCI6MjA3NDk2NTQ2NH0.1VVEkgThCltfebpCWa-4DReb9qSO5zdt2a_83CfsBsY';

  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // el helpers
  const $ = (id) => document.getElementById(id);
  const toast = (m) => { const t=$('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2500); };

  // DOM
  const enforceZips   = $('enforceZips');
  const enforceRadius = $('enforceRadius');
  const polSummary    = $('polSummary');

  const hqCompany = $('hqCompany');
  const hqStreet  = $('hqStreet');
  const hqCity    = $('hqCity');
  const hqState   = $('hqState');
  const hqZip     = $('hqZip');
  const geocodeBtn= $('geocodeBtn');
  const radiusMiles= $('radiusMiles');
  const saveRadiusBtn = $('saveRadiusBtn');
  const hqMeta    = $('hqMeta');
  const geoStatus = $('geoStatus');

  const zipInput  = $('zipInput');
  const addBtn    = $('addBtn');
  const zipsBody  = $('zipsBody');
  const statusRow = $('status');

  // auth guard
  (async () => {
    const { data: { session } } = await client.auth.getSession();
    if (!session) { location.href = '/admin/login.html'; return; }
  })();

  // load settings & zips
  async function loadSettings() {
    const { data, error } = await client.rpc('get_company_settings');
    if (error) { console.error(error); return; }

    // toggles
    enforceZips.checked   = !!data?.enforce_zip;
    enforceRadius.checked = !!data?.enforce_radius;

    // radius + HQ meta
    if (data?.radius_miles) radiusMiles.value = data.radius_miles;
    let hqLine = 'HQ: not set';
    if (data?.hq_lat && data?.hq_lon) {
      hqLine = `HQ: ${data?.hq_address ?? '(ZIP centroid)'} → lat=${Number(data.hq_lat).toFixed(6)}, lon=${Number(data.hq_lon).toFixed(6)} · radius=${data?.radius_miles ?? '—'} mi`;
    }
    hqMeta.textContent = hqLine;

    polSummary.textContent = `ZIPs: ${enforceZips.checked ? 'ON' : 'OFF'} · Radius: ${enforceRadius.checked ? 'ON' : 'OFF'}`;
  }

  async function loadZips() {
    const { data, error } = await client
      .from('company_zipcodes')
      .select('zipcode')
      .order('zipcode', { ascending: true });
    if (error) { console.error(error); return; }
    zipsBody.innerHTML = '';
    (data || []).forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.zipcode}</td>
        <td><button class="btn red" data-zip="${row.zipcode}">Delete</button></td>`;
      zipsBody.appendChild(tr);
    });
  }

  // toggle saves
  enforceZips.addEventListener('change', async () => {
    const { error } = await client.rpc('set_company_enforce_zip', { p_value: enforceZips.checked });
    if (error) { toast(error.message); return; }
    toast(`Service ZIPs ${enforceZips.checked ? 'enabled' : 'disabled'}`);
    loadSettings();
  });

  enforceRadius.addEventListener('change', async () => {
    const { error } = await client.rpc('set_company_enforce_radius', { p_value: enforceRadius.checked });
    if (error) { toast(error.message); return; }
    toast(`Radius enforcement ${enforceRadius.checked ? 'enabled' : 'disabled'}`);
    loadSettings();
  });

  // ZIP add/delete
  addBtn.addEventListener('click', async () => {
    const z = (zipInput.value || '').trim();
    if (!/^\d{5}$/.test(z)) { toast('ZIP must be 5 digits'); return; }
    const { error } = await client.rpc('upsert_company_zipcode', { p_zip: z });
    if (error) { toast(error.message); return; }
    toast(`Added ${z}`);
    zipInput.value = '';
    loadZips();
  });

  zipsBody.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-zip]');
    if (!btn) return;
    const z = btn.getAttribute('data-zip');
    const { error } = await client.rpc('delete_company_zipcode', { p_zip: z });
    if (error) { toast(error.message); return; }
    toast(`Deleted ${z}`);
    loadZips();
  });

  // Save radius only
  saveRadiusBtn.addEventListener('click', async () => {
    const miles = parseInt((radiusMiles.value || '').trim(), 10);
    if (!(miles > 0)) { toast('Enter a valid number of miles'); return; }
    const { error } = await client.rpc('set_company_radius_miles', { p_miles: miles });
    if (error) { toast(error.message); return; }
    toast('Radius saved');
    loadSettings();
  });

  // *** ZIP-based HQ setter (no external geocoder) ***
  geocodeBtn.addEventListener('click', async () => {
    geoStatus.textContent = 'Setting HQ from ZIP centroid...';
    const z = (hqZip.value || '').trim();
    if (!/^\d{5}$/.test(z)) { geoStatus.textContent = 'ZIP must be 5 digits.'; return; }

    // free-form address we’ll store for display (not used for lat/lon)
    const addr = [
      (hqCompany.value || '').trim(),
      (hqStreet.value  || '').trim(),
      [ (hqCity.value||'').trim(), (hqState.value||'').trim(), z ].filter(Boolean).join(' ')
    ].filter(Boolean).join(', ');

    const miles = parseInt((radiusMiles.value || '').trim(), 10);
    const { data, error } = await client.rpc('set_company_location_from_zip', {
      p_zip: z,
      p_radius_miles: Number.isFinite(miles) ? miles : null,
      p_hq_address: addr || z
    });
    if (error) { geoStatus.textContent = error.message; toast(error.message); return; }

    geoStatus.textContent = 'HQ saved from ZIP centroid.';
    toast('HQ updated');
    loadSettings();
  });

  // logout
  $('logoutLink').addEventListener('click', async (e) => {
    e.preventDefault();
    await client.auth.signOut();
    location.href = '/admin/login.html';
  });

  // init
  await loadSettings();
  await loadZips();
</script>
</body>
</html>
