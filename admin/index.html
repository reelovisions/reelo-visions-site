<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --ink:#111827; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; margin: 24px; color:#111827;}
    header { display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px; }
    nav a { margin-right: 12px; text-decoration:none; color:#2563eb; }
    nav a strong { color:#111827; }
    .card { border:1px solid var(--border); border-radius:12px; padding:16px; }
    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { padding:10px; border-bottom:1px solid #f0f0f0; text-align:left; vertical-align:top; }
    .muted { color:var(--muted); font-size:13px; }
    button { padding:6px 10px; border:1px solid #d1d5db; background:#fff; border-radius:8px; cursor:pointer; }
    button.primary { background:var(--ink); color:#fff; border-color:var(--ink); }
    .actions { display:flex; gap:6px; flex-wrap:wrap; }
    .status { margin-top:10px; font-size:14px; }
    .status.ok { color:#065f46; }
    .status.err { color:#991b1b; }
    dialog { border:1px solid var(--border); border-radius:12px; padding:16px; max-width:520px; }
    dialog .row { display:flex; gap:8px; margin-top:8px; align-items:center; }
    input[type=datetime-local], textarea { width:100%; padding:8px; border:1px solid #d1d5db; border-radius:8px; }
    textarea { min-height:120px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <header>
    <h1 style="margin:0;">Dashboard</h1>
    <nav>
      <a href="/admin/index.html"><strong>Dashboard</strong></a>
      <a href="/admin/service-areas.html">Service Areas</a>
      <a href="#" id="logout-link">Logout</a>
    </nav>
  </header>

  <div class="card">
    <h2 style="margin-top:0;">Upcoming Appointments</h2>
    <div class="muted">Live from <code>appointments_with_customer</code>.</div>
    <table>
      <thead>
        <tr>
          <th>When</th>
          <th>Customer</th>
          <th>Status</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="apptBody">
        <tr><td colspan="5" class="muted">Loading…</td></tr>
      </tbody>
    </table>
    <div id="status" class="status"></div>
  </div>

  <!-- Edit Notes Modal -->
  <dialog id="notesDialog">
    <form method="dialog" id="notesForm">
      <h3 style="margin-top:0;">Edit Notes</h3>
      <input type="hidden" id="notesApptId" />
      <label class="muted">Type plain text or paste JSON</label>
      <textarea id="notesInput" placeholder='Example: {"tech":"Sam","priority":"high"} or just: Noisy outdoor unit'></textarea>
      <div class="row" style="justify-content:flex-end;">
        <button type="button" id="notesCancel">Close</button>
        <button class="primary" id="notesSave" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Reschedule Modal -->
  <dialog id="reschedDialog">
    <form method="dialog" id="reschedForm">
      <h3 style="margin-top:0;">Reschedule</h3>
      <input type="hidden" id="reschedApptId" />
      <label class="muted">New Date/Time (local)</label>
      <input id="reschedWhen" type="datetime-local" required />
      <div class="row" style="justify-content:flex-end;">
        <button type="button" id="reschedCancel">Close</button>
        <button class="primary" id="reschedSave" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Cancel Modal -->
  <dialog id="cancelDialog">
    <form method="dialog" id="cancelForm">
      <h3 style="margin-top:0;">Cancel Appointment</h3>
      <input type="hidden" id="cancelApptId" />
      <p class="muted">This sets <code>status = 'canceled'</code> and <code>canceled_at = now()</code>.</p>
      <div class="row" style="justify-content:flex-end;">
        <button type="button" id="cancelClose">Close</button>
        <button class="primary" id="cancelConfirm" value="default">Confirm Cancel</button>
      </div>
    </form>
  </dialog>

<script>
  // ---------- Config ----------
  const SUPABASE_URL = 'https://yvjwajopxbcaedzofqww.supabase.co';
  // Paste the SAME anon key you already use in /admin/login.html
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2andham9weGJjYWVkem9mcXd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODk0NjQsImV4cCI6MjA3NDk2NTQ2NH0.1VVEkgThCltfebpCWa-4DReb9qSO5zdt2a_83CfsBsY';

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---------- Auth Guard ----------
  (async () => {
    const { data: { session } } = await client.auth.getSession();
    if (!session) {
      window.location.href = '/admin/login.html';
      return;
    }
    await loadUpcoming();
  })();

  document.getElementById('logout-link').addEventListener('click', async (e) => {
    e.preventDefault();
    await client.auth.signOut();
    window.location.href = '/admin/login.html';
  });

  const statusEl = document.getElementById('status');
  function ok(msg){ statusEl.textContent = msg; statusEl.className = 'status ok'; }
  function err(msg){ statusEl.textContent = msg; statusEl.className = 'status err'; }

  // ---------- Table rendering ----------
  async function loadUpcoming() {
    statusEl.textContent = '';
    const tbody = document.getElementById('apptBody');
    tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading…</td></tr>';

    // Our tolerant view returns: id (TEXT), scheduled_at (timestamptz|null), status, notes, customer_name, customer_phone
    const { data, error } = await client
      .from('appointments_with_customer')
      .select('id, scheduled_at, status, notes, customer_name, customer_phone')
      .neq('status', 'canceled')
      .order('scheduled_at', { ascending: true })
      .limit(200);

    if (error) {
      tbody.innerHTML = '';
      err(error.message);
      return;
    }

    tbody.innerHTML = '';
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="muted">No upcoming appointments.</td></tr>';
      return;
    }

    for (const appt of data) {
      tbody.appendChild(renderApptRow(appt));
    }
  }

  function renderApptRow(a) {
    const tr = document.createElement('tr');

    const when = a.scheduled_at ? new Date(a.scheduled_at) : null;
    const tdWhen = document.createElement('td');
    tdWhen.textContent = when ? when.toLocaleString() : '—';

    const tdCust = document.createElement('td');
    tdCust.innerHTML = `<div>${escapeHtml(a.customer_name || '—')}</div>
                        <div class="muted">${escapeHtml(a.customer_phone || '')}</div>`;

    const tdStatus = document.createElement('td');
    tdStatus.textContent = a.status || 'scheduled';

    const tdNotes = document.createElement('td');
    tdNotes.textContent = formatNotes(a.notes);

    const tdAct = document.createElement('td');
    tdAct.className = 'actions';

    const btnNotes = document.createElement('button');
    btnNotes.textContent = 'Edit Notes';
    btnNotes.addEventListener('click', () => openNotesModal(a));

    const btnRes = document.createElement('button');
    btnRes.textContent = 'Reschedule';
    btnRes.addEventListener('click', () => openReschedModal(a));

    const btnCancel = document.createElement('button');
    btnCancel.textContent = 'Cancel';
    btnCancel.addEventListener('click', () => openCancelModal(a));

    tdAct.append(btnNotes, btnRes, btnCancel);
    tr.append(tdWhen, tdCust, tdStatus, tdNotes, tdAct);
    return tr;
  }

  function escapeHtml(s) {
    return (s ?? '').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ---------- Notes display: prefer plain text; unwrap {"text": "..."}; otherwise JSON.stringify ----------
  function formatNotes(n) {
    if (n == null) return '—';
    if (typeof n === 'string') return n;
    if (typeof n === 'object') {
      if (typeof n.text === 'string') return n.text;
      try { return JSON.stringify(n); } catch { return '—'; }
    }
    return '—';
  }

  // ---------- Notes modal ----------
  const notesDialog = document.getElementById('notesDialog');
  const notesApptId = document.getElementById('notesApptId');
  const notesInput  = document.getElementById('notesInput');
  document.getElementById('notesCancel').addEventListener('click', () => notesDialog.close());
  document.getElementById('notesSave').addEventListener('click', async (e) => {
    e.preventDefault();
    await saveNotes();
  });

  function openNotesModal(a) {
    notesApptId.value = a.id; // id is TEXT in our view
    try {
      if (typeof a.notes === 'string') {
        notesInput.value = a.notes;
      } else if (a.notes && typeof a.notes.text === 'string') {
        notesInput.value = a.notes.text;
      } else {
        notesInput.value = a.notes ? JSON.stringify(a.notes, null, 2) : '';
      }
    } catch {
      notesInput.value = '';
    }
    notesDialog.showModal();
  }

  async function saveNotes() {
    const id = notesApptId.value;            // TEXT id
    const raw = (notesInput.value || '').trim();
    let payload;

    if (!raw) {
      payload = {};                           // if cleared, store empty object
    } else {
      // If valid JSON, store JSON; else store as string
      try { payload = JSON.parse(raw); }
      catch { payload = raw; }
    }

    const { error } = await client.rpc('update_appointment_notes', { p_id: id, p_notes: payload });
    if (error) { err(error.message); return; }
    notesDialog.close();
    ok('Notes updated');
    await loadUpcoming();
  }

  // ---------- Reschedule ----------
  const reschedDialog = document.getElementById('reschedDialog');
  const reschedApptId = document.getElementById('reschedApptId');
  const reschedWhen   = document.getElementById('reschedWhen');
  document.getElementById('reschedCancel').addEventListener('click', () => reschedDialog.close());
  document.getElementById('reschedSave').addEventListener('click', async (e) => {
    e.preventDefault();
    await saveReschedule();
  });

  function toLocalInputValue(d) {
    const pad = (n) => String(n).padStart(2, '0');
    const y = d.getFullYear();
    const m = pad(d.getMonth()+1);
    const day = pad(d.getDate());
    const h = pad(d.getHours());
    const min = pad(d.getMinutes());
    return `${y}-${m}-${day}T${h}:${min}`;
  }

  function openReschedModal(a) {
    reschedApptId.value = a.id; // TEXT id
    const dt = a.scheduled_at ? new Date(a.scheduled_at) : new Date();
    reschedWhen.value = toLocalInputValue(dt);
    reschedDialog.showModal();
  }

  async function saveReschedule() {
    const id = reschedApptId.value;
    const localStr = reschedWhen.value; // "YYYY-MM-DDTHH:mm" local
    if (!localStr) { err('Please pick a new date/time'); return; }
    const iso = new Date(localStr).toISOString();
    const { error } = await client.rpc('reschedule_appointment', { p_id: id, p_at: iso });
    if (error) { err(error.message); return; }
    reschedDialog.close();
    ok('Appointment rescheduled');
    await loadUpcoming();
  }

  // ---------- Cancel ----------
  const cancelDialog = document.getElementById('cancelDialog');
  const cancelApptId = document.getElementById('cancelApptId');
  document.getElementById('cancelClose').addEventListener('click', () => cancelDialog.close());
  document.getElementById('cancelConfirm').addEventListener('click', async (e) => {
    e.preventDefault();
    await doCancel();
  });

  function openCancelModal(a) {
    cancelApptId.value = a.id; // TEXT id
    cancelDialog.showModal();
  }

  async function doCancel() {
    const id = cancelApptId.value;
    const { error } = await client.rpc('cancel_appointment', { p_id: id });
    if (error) { err(error.message); return; }
    cancelDialog.close();
    ok('Appointment canceled');
    await loadUpcoming();
  }
</script>
</body>
</html>
