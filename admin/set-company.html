<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Service Areas | Admin</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    :root{--bg:#0b1220;--panel:#111a2b;--muted:#8091a7;--txt:#e8f0ff;--brand:#3b82f6;--brand-2:#2563eb;--danger:#ef4444}
    *{box-sizing:border-box} body{margin:0;font:16px/1.5 system-ui,Segoe UI,Arial;color:var(--txt);background:radial-gradient(1200px 1200px at 10% -10%,#13213c 0%,var(--bg) 40%) fixed}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;margin-bottom:20px}
    h1{font-size:32px;margin:0}
    nav a{color:var(--muted);text-decoration:none;margin-right:16px}
    .card{background:var(--panel);border:1px solid #1f2a44;border-radius:14px;padding:18px 20px;margin:18px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-5{grid-column:span 5} .col-6{grid-column:span 6}
    label{display:block;font-size:12px;color:var(--muted);margin:4px 2px}
    input{width:100%;padding:12px 12px;border-radius:10px;border:1px solid #26324f;background:#0e1830;color:var(--txt)}
    button{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff}
    .muted{color:var(--muted);font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 8px;border-bottom:1px solid #1f2a44}
    th{color:#9fb0c8;text-align:left}
    .danger{background:linear-gradient(180deg,#f87171,#ef4444);color:#fff}
    .pill{display:inline-block;background:#152141;border:1px solid #233055;border-radius:999px;padding:6px 10px;color:#bbcade;font-size:12px}
    #toast{position:fixed;right:16px;bottom:16px;background:#0e1830;border:1px solid #213054;padding:10px 12px;border-radius:10px;display:none}
    .err{color:#ffb4b4}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Service Areas</h1>
      <nav>
        <a href="/admin/index.html">Dashboard</a>
        <a href="/admin/service-areas.html" style="color:#fff">Service Areas</a>
        <a href="/admin/new-appointment.html">New Appointment</a>
        <a href="/admin/logout.html">Logout</a>
      </nav>
    </header>

    <div class="card">
      <h2>Policies</h2>
      <p class="muted">We’ll wire these toggles later; today we’re getting ZIPs working end-to-end.</p>
      <span class="pill" id="policyStatus">ZIPS: unknown</span>
    </div>

    <div class="card">
      <h2>HQ Location & Radius</h2>
      <div class="row">
        <div class="col-5">
          <label>Company (optional)</label>
          <input id="companyName" placeholder="e.g. Reelo Heating & Air">
        </div>
        <div class="col-2">
          <label>Radius (miles)</label>
          <input id="radius" value="25">
        </div>
        <div class="col-2">
          <label>&nbsp;</label>
          <button class="primary" id="saveRadiusBtn">Save radius</button>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col-6">
          <label>Street</label>
          <input id="street" placeholder="123 Main St">
        </div>
        <div class="col-3">
          <label>City</label>
          <input id="city" placeholder="McKinney">
        </div>
        <div class="col-1">
          <label>State</label>
          <input id="state" placeholder="TX">
        </div>
        <div class="col-2">
          <label>ZIP</label>
          <input id="hqZip" placeholder="75071">
        </div>
        <div class="col-3">
          <label>&nbsp;</label>
          <button class="primary" id="geocodeBtn">Set location (geocode)</button>
        </div>
      </div>
      <p class="muted" id="hqMeta">HQ: not set</p>
    </div>

    <div class="card">
      <h2>ZIP Codes</h2>
      <div class="row">
        <div class="col-3">
          <label>Add ZIP</label>
          <input id="zipInput" maxlength="5" placeholder="e.g. 55401" />
        </div>
        <div class="col-2">
          <label>&nbsp;</label>
          <button class="primary" id="addZipBtn">Add</button>
        </div>
      </div>

      <table>
        <thead><tr><th style="width:120px">ZIP</th><th>Action</th></tr></thead>
        <tbody id="zipsBody"><tr><td colspan="2" class="muted">Loading…</td></tr></tbody>
      </table>
      <p class="muted" id="zipStatus"></p>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // ======= 1) PUT YOUR REAL VALUES HERE  =======
    const SUPABASE_URL  = 'https://yvjwajopxbcaedzofqww.supabase.co';  // <-- YOUR project URL
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2andham9weGJjYWVkem9mcXd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODk0NjQsImV4cCI6MjA3NDk2NTQ2NH0.1VVEkgThCltfebpCWa-4DReb9qSO5zdt2a_83CfsBsY'; // <-- YOUR anon key
    // =============================================

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const toast = (msg, isErr=false) => {
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.display = 'block';
      t.className = isErr ? 'err' : '';
      setTimeout(()=>{ t.style.display='none' }, 2600);
    };

    // Sign in anonymously (so browser can call DB)
    async function ensureAuth() {
      const { data: session } = await sb.auth.getSession();
      if (!session.session) {
        const { error } = await sb.auth.signInAnonymously();
        if (error) { toast('Auth error: ' + error.message, true); throw error; }
      }
    }

    // Small helpers for RPC/REST with nice errors
    async function callRpc(name, args) {
      const { data, error, status } = await sb.rpc(name, args ?? {});
      if (error) {
        // surface 404 distinctly so we can fall back to REST
        const e = new Error(error.message); e.status = status; throw e;
      }
      return data;
    }
    async function restSelect(path, params) {
      const url = new URL(SUPABASE_URL + '/rest/v1/' + path);
      Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k,v));
      const res = await fetch(url, {
        headers: {
          apikey: SUPABASE_ANON,
          Authorization: `Bearer ${SUPABASE_ANON}`
        }
      });
      if (!res.ok) throw new Error('REST ' + res.status);
      return res.json();
    }

    // =============== ZIPs ==================
    async function loadZips() {
      const body = document.getElementById('zipsBody');
      body.innerHTML = `<tr><td colspan="2" class="muted">Loading…</td></tr>`;
      try {
        // try RPC first
        let rows;
        try {
          rows = await callRpc('zips_list');
        } catch (e) {
          if (e.status === 404) {
            // RPC missing — fall back to REST (RLS must restrict to your company)
            rows = await restSelect('company_zip_codes', { select: 'zip', order: 'zip.asc' });
          } else { throw e; }
        }
        if (!rows || !rows.length) {
          body.innerHTML = `<tr><td colspan="2" class="muted">No ZIPs yet.</td></tr>`;
          return;
        }
        body.innerHTML = rows.map(r => `
          <tr>
            <td><code>${String(r.zip).padStart(5,'0')}</code></td>
            <td><button class="danger" data-zip="${r.zip}">Delete</button></td>
          </tr>`).join('');
      } catch (e) {
        console.error(e);
        document.getElementById('zipStatus').textContent = 'Could not load ZIPs.';
      }
    }

    async function addZip() {
      const input = document.getElementById('zipInput');
      const raw = (input.value || '').trim();
      const zip = raw.replace(/\D/g,'').padStart(5,'0');
      if (zip.length !== 5) { toast('ZIP must be 5 digits.', true); return; }
      try {
        try {
          await callRpc('zips_add', { p_zip: zip });
        } catch (e) {
          if (e.status === 404) {
            // RPC missing — upsert via REST (RLS should fill company_id from session)
            const url = SUPABASE_URL + '/rest/v1/company_zip_codes';
            const res = await fetch(url, {
              method: 'POST',
              headers: {
                'content-type': 'application/json',
                apikey: SUPABASE_ANON,
                Authorization: `Bearer ${SUPABASE_ANON}`,
                Prefer: 'resolution=merge-duplicates'
              },
              body: JSON.stringify([{ zip }])
            });
            if (!res.ok) throw new Error('REST add ZIP ' + res.status);
          } else { throw e; }
        }
        input.value = '';
        toast('ZIP added');
        await loadZips();
      } catch (err) {
        console.error(err);
        toast('Add ZIP failed: ' + err.message, true);
      }
    }

    async function deleteZip(zip) {
      try {
        try {
          await callRpc('zips_delete', { p_zip: String(zip) });
        } catch (e) {
          if (e.status === 404) {
            // RPC missing — REST delete
            const url = new URL(SUPABASE_URL + '/rest/v1/company_zip_codes');
            url.searchParams.set('zip', 'eq.'+zip);
            const res = await fetch(url, {
              method: 'DELETE',
              headers: { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}` }
            });
            if (!res.ok) throw new Error('REST delete ZIP ' + res.status);
          } else { throw e; }
        }
        toast('ZIP deleted');
        await loadZips();
      } catch (err) {
        console.error(err);
        toast('Delete ZIP failed: ' + err.message, true);
      }
    }

    // Wire events
    document.getElementById('addZipBtn').addEventListener('click', addZip);
    document.getElementById('zipsBody').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-zip]');
      if (btn) deleteZip(btn.getAttribute('data-zip'));
    });

    // HQ buttons (non-blocking placeholders for now)
    document.getElementById('geocodeBtn').addEventListener('click', () => {
      toast('Geocode not wired yet (focus is ZIPs).');
    });
    document.getElementById('saveRadiusBtn').addEventListener('click', () => {
      toast('Save radius not wired yet (focus is ZIPs).');
    });

    // Boot
    (async () => {
      try {
        await ensureAuth();      // must succeed
        await loadZips();        // then load ZIP list
      } catch (e) {
        // already toasted
      }
    })();
  </script>
</body>
</html>
